<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حساباتك — Aite</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/4/46/1000084215-removebg-preview.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(57, 130, 247, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 90%, rgba(120, 50, 220, 0.1) 0%, transparent 30%);
            color: #e4e6eb;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .account-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .account-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(57, 130, 247, 0.4);
            transform: translateY(-3px);
        }

        .remove-btn {
            background: rgba(255, 0, 0, 0.1);
            color: #ff5555;
            opacity: 0;
            transition: all 0.2s;
        }
        .account-card:hover .remove-btn { opacity: 1; }
        .remove-btn:hover { background: #ff5555; color: white; transform: scale(1.1); }
        
        .add-account-btn {
            border: 1px dashed rgba(255, 255, 255, 0.2);
            color: #9ca3af;
        }
        .add-account-btn:hover { border-color: #3982f7; color: #fff; background: rgba(57, 130, 247, 0.05); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="flex flex-col items-center justify-center py-10">

    <div class="text-center mb-10 animate-fade-in">
        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a0/Sond_skyline_from_top_City_Hall_-_Aug_2025.jpg" 
             class="w-20 h-20 rounded-2xl object-cover mx-auto mb-4 border border-white/10 shadow-lg shadow-blue-500/20" 
             alt="Aite Logo">
        <h1 class="text-4xl font-bold tracking-wider text-white">Aite</h1>
        <p class="text-gray-400 text-sm mt-2">اختر حساباً للمتابعة</p>
    </div>

    <div class="w-full max-w-[400px] px-4 space-y-4" id="accountsListWrapper"></div>

    <div class="w-full max-w-[400px] px-4 mt-2">
        <a href="/login" class="add-account-btn w-full p-4 rounded-xl flex items-center justify-center gap-3 font-semibold group cursor-pointer no-underline block transition-all">
            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-blue-500/20 transition-colors">
                <i class="fas fa-plus text-sm"></i>
            </div>
            <span>تسجيل الدخول بحساب آخر</span>
        </a>
        
        <div class="text-center mt-8">
            <a href="/register" class="text-sm text-blue-400 hover:text-blue-300 transition-colors">إنشاء حساب جديد</a>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'aite_accounts_secure_v2';
        const DEFAULT_AVATAR = 'https://res.cloudinary.com/duixjs8az/image/upload/v1766905033/post_media/1766905033352-default_profile.png';

        function loadAccounts() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch (e) { return []; }
        }

        function saveAccounts(list) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }

        function removeAccount(e, username) {
            e.stopPropagation(); 
            e.preventDefault();
            if(confirm('هل أنت متأكد من إزالة @' + username + ' من الجهاز؟')) {
                let accounts = loadAccounts();
                accounts = accounts.filter(acc => acc.username !== username);
                saveAccounts(accounts);
                renderAccounts();
            }
        }

        function handleAccountClick(username) {
            const accounts = loadAccounts();
            const account = accounts.find(a => a.username === username);

            if (account && account.auth_token) {
                // محاكاة عملية الدخول الآمن
                try {
                    // فك تشفير كلمة المرور المخزنة
                    const decodedPass = atob(account.auth_token);
                    
                    // إنشاء نموذج (Form) ديناميكي لإرسال البيانات للسيرفر
                    // هذا يضمن إنشاء جلسة (Session) في السيرفر
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/login';
                    form.style.display = 'none';

                    // حقل اسم المستخدم
                    const userField = document.createElement('input');
                    userField.type = 'hidden';
                    userField.name = 'username';
                    userField.value = username;
                    form.appendChild(userField);

                    // حقل كلمة المرور
                    const passField = document.createElement('input');
                    passField.type = 'hidden';
                    passField.name = 'password';
                    passField.value = decodedPass;
                    form.appendChild(passField);

                    // إضافة النموذج للصفحة وإرساله
                    document.body.appendChild(form);
                    
                    // تأثير بسيط للانتظار
                    document.body.style.opacity = '0.5';
                    document.body.style.cursor = 'wait';
                    
                    form.submit();

                } catch (e) {
                    console.error("Auth error", e);
                    window.location.href = `/login?username=${encodeURIComponent(username)}`;
                }
            } else {
                window.location.href = `/login?username=${encodeURIComponent(username)}`;
            }
        }

        function renderAccounts() {
            const container = document.getElementById('accountsListWrapper');
            const accounts = loadAccounts();
            container.innerHTML = '';

            if (accounts.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">لا توجد حسابات محفوظة</p>';
                return;
            }

            accounts.forEach((acc, index) => {
                const imgUrl = acc.profile_picture_url || DEFAULT_AVATAR;
                const delayStyle = `animation-delay: ${index * 100}ms`;

                const cardHtml = `
                    <div class="account-card flex items-center p-4 gap-4 animate-fade-in group relative" 
                         style="${delayStyle}"
                         onclick="handleAccountClick('${acc.username}')">
                        
                        <img src="${imgUrl}" class="w-14 h-14 rounded-full object-cover border-2 border-transparent group-hover:border-blue-500 transition-colors bg-gray-800" 
                             alt="${acc.username}" onerror="this.src='${DEFAULT_AVATAR}'">

                        <div class="flex-grow text-right overflow-hidden">
                            <h3 class="text-white font-bold text-lg leading-tight truncate">${acc.full_name || acc.username}</h3>
                            <p class="text-gray-400 text-sm font-mono truncate">@${acc.username}</p>
                        </div>

                        <button class="remove-btn absolute top-3 left-3 w-8 h-8 rounded-full flex items-center justify-center" 
                                onclick="removeAccount(event, '${acc.username}')">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <div class="text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity absolute bottom-4 left-4">
                             <i class="fas fa-arrow-left"></i>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        document.addEventListener('DOMContentLoaded', renderAccounts);
        // Global Function لاستقبال التوكن من الأندرويد
window.receiveAndroidToken = function(token) {
    console.log("Received FCM Token from Android:", token);
    
    // إرسال التوكن إلى السيرفر لحفظه في قاعدة البيانات للمستخدم الحالي
    fetch('/api/save-fcm-token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ token: token })
    }).catch(err => console.error("Error saving token", err));
};
    </script>
</body>
</html>
