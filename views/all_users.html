<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aite - كل المستخدمين وطلبات الصداقة</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { background: #000; color: #e4e6eb; font-family: Inter, system-ui, sans-serif; }
    .glass-navbar { background-color: rgba(30,30,30,0.5); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.06); }
    .user-card { background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); border-radius: 12px; padding:10px; display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .user-info { display:flex; gap:10px; align-items:center; min-width:0; text-decoration: none; color: inherit; transition: opacity 0.2s; }
    .user-info:hover { opacity: 0.8; }
    .user-name { font-weight:700; color:#e6eefb; }
    .user-sub { color:#9fb3c8; font-size:13px; }
    .action-btn { padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color:#e6eefb; cursor:pointer; }
    .action-btn.message { background: #10b981; color: #fff; border: none; padding: 6px 10px; border-radius: 12px; font-size: 13px; box-shadow: 0 2px 6px rgba(16,185,129,0.12); text-decoration: none; }
    .tab { padding:8px 12px; cursor:pointer; border-radius:999px; }
    .tab.active { background:#111827; border:1px solid rgba(255,255,255,0.04); }
    .friend-req-badge { position: absolute; top: -6px; left: -6px; min-width: 18px; height: 18px; padding: 0 6px; background: #ef4444; color:#fff; font-size:12px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; }
    .mobile-safe { padding-bottom:84px; }
    .btn-accept { background: #16a34a; color: #fff; padding: 6px 10px; font-size: 13px; border-radius: 12px; border: none; }
    .btn-reject { background: #ef4444; color: #fff; padding: 6px 10px; font-size: 13px; border-radius: 12px; border: none; }
    @media (max-width:480px) { .action-btn.message, .btn-accept, .btn-reject { padding:5px 8px; font-size:12px; border-radius:10px; } }

    /* VERIFIED BADGE IMAGE */
    .verified-badge-img {
      display: inline-block;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      margin-left: 6px;
      object-fit: cover;
      box-shadow: 0 2px 6px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.06);
      vertical-align: middle;
    }

    /* ------------------ Toasts (black glassy) ------------------ */
    #toastContainer {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1100;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
        pointer-events: none;
    }
    .toast {
        min-width: 220px;
        max-width: 90vw;
        color: #ffffff;
        background: rgba(7,7,8,0.6);
        border: 1px solid rgba(255,255,255,0.06);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        padding: 10px 14px;
        border-radius: 12px;
        box-shadow: 0 6px 24px rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        gap: 10px;
        pointer-events: auto;
        font-size: 14px;
    }
    .toast.success { border-left: 4px solid #16a34a; }
    .toast.error   { border-left: 4px solid #ef4444; }
    .toast.info    { border-left: 4px solid #3b82f6; }
    .toast i { width: 18px; text-align: center; }
    .toast .msg { flex: 1; word-break: break-word; text-align: right; }
    .toast .close-btn { margin-left: 8px; background: transparent; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 14px; }
  </style>
</head>
<body class="mobile-safe">

  <header class="glass-navbar sticky top-0 z-50 p-3">
    <nav class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/chat_list" class="text-gray-400 hover:text-white p-2"><i class="fas fa-arrow-right text-2xl"></i></a>
      </div>

      <div class="text-center">
        <h1 class="text-lg font-bold">اكتشف المستخدمين</h1>
      </div>

      <div style="width:40px; display:flex; gap:8px; align-items:center; justify-content:flex-end; position:relative;">
        <span id="friendReqTopBadge" class="friend-req-badge" style="display:none;">0</span>
      </div>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <div class="flex gap-3 mb-4">
      <div id="tabAll" class="tab active">كل المستخدمين</div>
      <div id="tabRequests" class="tab">طلبات الصداقة</div>
    </div>

    <div id="allUsersContainer" class="space-y-3">
      <div class="text-center text-gray-400 p-6"><i class="fas fa-spinner fa-spin"></i> جاري تحميل المستخدمين...</div>
    </div>

    <div id="requestsContainer" class="space-y-3 hidden">
      <div class="text-center text-gray-400 p-6"><i class="fas fa-spinner fa-spin"></i> جاري تحميل طلبات الصداقة...</div>
    </div>
  </main>

  <!-- Toast container -->
  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<script>
  const VERIFIED_IMG_URL = "https://res.cloudinary.com/duixjs8az/image/upload/v1768036959/post_media/1768036959482-badge.png";
  const tabAll = document.getElementById('tabAll');
  const tabRequests = document.getElementById('tabRequests');
  const allUsersContainer = document.getElementById('allUsersContainer');
  const requestsContainer = document.getElementById('requestsContainer');
  const friendReqTopBadge = document.getElementById('friendReqTopBadge');

  tabAll.addEventListener('click', () => { tabAll.classList.add('active'); tabRequests.classList.remove('active'); allUsersContainer.classList.remove('hidden'); requestsContainer.classList.add('hidden'); });
  tabRequests.addEventListener('click', () => { tabRequests.classList.add('active'); tabAll.classList.remove('active'); requestsContainer.classList.remove('hidden'); allUsersContainer.classList.add('hidden'); loadRequests(); });

  /* ---------------- Toast helper (black glassy) ---------------- */
  function showToast(message, opts = {}) {
    const { type = 'info', duration = 3500 } = opts;
    let container = document.getElementById('toastContainer');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.setAttribute('role', 'status');
    toast.innerHTML = `
      <i class="${type === 'success' ? 'fas fa-check-circle' : (type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle')}"></i>
      <div class="msg">${escapeHtml(message)}</div>
      <button class="close-btn" aria-label="close">&times;</button>
    `;

    const closeBtn = toast.querySelector('.close-btn');
    const removeToast = () => {
      toast.style.transition = 'transform .18s cubic-bezier(.2,.8,.2,1), opacity .18s';
      toast.style.transform = 'translateY(-10px)';
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 200);
    };
    closeBtn.addEventListener('click', removeToast);

    container.appendChild(toast);

    // entrance animation
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-10px)';
    requestAnimationFrame(() => {
      toast.style.transition = 'transform .18s cubic-bezier(.2,.8,.2,1), opacity .18s';
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    });

    const t = setTimeout(() => {
      removeToast();
    }, duration);

    // pause on hover
    toast.addEventListener('mouseenter', () => clearTimeout(t));
  }

  async function loadAllUsers() {
    allUsersContainer.innerHTML = '<div class="text-center text-gray-400 p-6"><i class="fas fa-spinner fa-spin"></i> جاري تحميل المستخدمين...</div>';
    try {
      const res = await fetch('/api/users/all', { credentials: 'include' });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error('failed');

      if (data.users.length === 0) {
        allUsersContainer.innerHTML = '<div class="text-center text-gray-500 p-6">لا يوجد مستخدمون آخرون.</div>';
        return;
      }

      allUsersContainer.innerHTML = data.users.map(u => {
        let btnHtml = '';
        if (u.is_friend) {
          btnHtml = `<a href="/chat?contactId=${u.id}" class="action-btn message">مراسلة</a>`;
        } else if (u.request_received) {
          btnHtml = `<span class="action-btn">طلب وارد</span>`;
        } else if (u.request_sent) {
          btnHtml = `<button class="action-btn" data-id="${u.id}" data-action="cancel">إلغاء الطلب</button>`;
        } else {
          btnHtml = `<button class="action-btn" data-id="${u.id}" data-action="send">إضافة صديق</button>`;
        }

        // placeholder for verified badge; will be updated later
        const verifiedPlaceholder = `<span class="verified-placeholder" data-user-id="${u.id}"></span>`;

        return `<div class="user-card">
          <a href="/profile?userId=${u.id}" class="user-info">
            <img src="${escapeHtml(u.profile_picture_url || '/assets/default_profile_pic.png')}" class="w-12 h-12 rounded-full object-cover">
            <div style="min-width:0">
              <div class="user-name">@${escapeHtml(u.username)} ${verifiedPlaceholder}</div>
              <div class="user-sub">${escapeHtml(u.full_name || '')}</div>
            </div>
          </a>
          <div>${btnHtml}</div>
        </div>`;
      }).join('');

      // bind actions
      document.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const action = e.currentTarget.getAttribute('data-action');
          if (action === 'send') {
            e.currentTarget.disabled = true;
            e.currentTarget.textContent = 'جاري الإرسال...';
            try {
              const r = await fetch('/api/friends/request', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ to_id: id })});
              const j = await r.json();
              if (r.ok && j.ok) { loadAllUsers(); updateFriendReqBadge(); showToast('تم إرسال طلب الصداقة.', { type: 'success' }); }
              else { showToast(j.error || 'فشل إرسال الطلب', { type: 'error' }); e.currentTarget.disabled = false; loadAllUsers(); }
            } catch (err) { showToast('خطأ في الشبكة', { type: 'error' }); e.currentTarget.disabled = false; loadAllUsers(); }
          } else if (action === 'cancel') {
            e.currentTarget.disabled = true;
            e.currentTarget.textContent = 'جاري الإلغاء...';
            try {
              const r = await fetch('/api/friends/cancel', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ to_id: id })});
              const j = await r.json();
              if (r.ok && j.ok) { loadAllUsers(); updateFriendReqBadge(); showToast('تم إلغاء الطلب.', { type: 'success' }); }
              else { showToast('فشل الإلغاء', { type: 'error' }); loadAllUsers(); }
            } catch (err) { showToast('خطأ', { type: 'error' }); loadAllUsers(); }
          }
        });
      });

      // تحديث شارات التوثيق بعد العرض
      updateVerifiedBadges();

    } catch (e) {
      allUsersContainer.innerHTML = '<div class="text-center text-red-500 p-6">فشل في تحميل المستخدمين.</div>';
    }
  }

  async function loadRequests() {
    requestsContainer.innerHTML = '<div class="text-center text-gray-400 p-6"><i class="fas fa-spinner fa-spin"></i> جاري تحميل الطلبات...</div>';
    try {
      const res = await fetch('/api/friends/requests', { credentials: 'include' });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error('failed');

      if (!data.requests || data.requests.length === 0) {
        requestsContainer.innerHTML = '<div class="text-center text-gray-500 p-6">لا توجد طلبات صداقة واردة.</div>';
        updateFriendReqBadge();
        return;
      }

      requestsContainer.innerHTML = data.requests.map(r => {
        // placeholder for verified badge in requests list (profile might include is_verified)
        const verifiedPlaceholder = `<span class="verified-placeholder" data-user-id="${r.from}"></span>`;
        return `<div class="user-card">
          <a href="/profile?userId=${r.from}" class="user-info">
            <img src="${escapeHtml(r.profile_picture_url || '/assets/default_profile_pic.png')}" class="w-12 h-12 rounded-full object-cover">
            <div style="min-width:0">
              <div class="user-name">@${escapeHtml(r.username)} ${verifiedPlaceholder}</div>
            </div>
          </a>
          <div>
            <button class="btn-accept" data-action="accept" data-id="${r.from}">قبول</button>
            <button class="btn-reject" data-action="reject" data-id="${r.from}">رفض</button>
          </div>
        </div>`;
      }).join('');

      document.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const action = e.currentTarget.getAttribute('data-action');
          if (action === 'accept') {
            e.currentTarget.disabled = true;
            try {
              const r = await fetch('/api/friends/accept', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ from_id: id })});
              const j = await r.json();
              if (r.ok && j.ok) { loadRequests(); updateFriendReqBadge(); showToast('تمت الموافقة — أصبح هذا المستخدم صديقك.', { type: 'success' }); }
              else { showToast('فشل في القبول', { type: 'error' }); loadRequests(); }
            } catch (err) { showToast('خطأ', { type: 'error' }); loadRequests(); }
          } else if (action === 'reject') {
            e.currentTarget.disabled = true;
            try {
              const r = await fetch('/api/friends/reject', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ from_id: id })});
              const j = await r.json();
              if (r.ok && j.ok) { loadRequests(); updateFriendReqBadge(); showToast('تم رفض الطلب.', { type: 'success' }); }
              else { showToast('فشل', { type: 'error' }); loadRequests(); }
            } catch (err) { showToast('خطأ', { type: 'error' }); loadRequests(); }
          }
        });
      });

      // update badges for request users too
      updateVerifiedBadges();

      updateFriendReqBadge();

    } catch (e) {
      requestsContainer.innerHTML = '<div class="text-center text-red-500 p-6">فشل في تحميل الطلبات.</div>';
    }
  }

  async function updateFriendReqBadge() {
    try {
      const r = await fetch('/api/friends/requests_count', { credentials: 'same-origin' });
      const j = await r.json();
      if (r.ok && j.ok) {
        if (j.count > 0) { friendReqTopBadge.style.display = 'inline-flex'; friendReqTopBadge.textContent = j.count > 99 ? '99+' : String(j.count); }
        else friendReqTopBadge.style.display = 'none';
      }
    } catch (e) { /* ignore */ }
  }

  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  // SSE to update friend requests badge live
  (function setupSSE() {
    if (!window.EventSource) return;
    const es = new EventSource('/api/notifications/stream', { withCredentials: true });
    es.addEventListener('notifications', e => {
      try {
        const p = JSON.parse(e.data);
        const pending = p.pending_friend_requests_count || 0;
        if (pending > 0) { friendReqTopBadge.style.display = 'inline-flex'; friendReqTopBadge.textContent = pending > 99 ? '99+' : String(pending); }
        else friendReqTopBadge.style.display = 'none';
      } catch (err) {}
    });
    es.addEventListener('error', (err) => { /* ignore */ });
  })();

  // ----------------- VERIFIED BADGES HELPERS -----------------
  async function updateVerifiedBadges() {
    const placeholders = Array.from(document.querySelectorAll('.verified-placeholder'));
    if (placeholders.length === 0) return;
    await Promise.all(placeholders.map(async ph => {
      const uid = ph.dataset.userId;
      if (!uid) return;
      try {
        const res = await fetch(`/api/profile?userId=${encodeURIComponent(uid)}`, { credentials: 'same-origin' });
        if (!res.ok) { ph.remove(); return; }
        const data = await res.json();
        if (data && data.ok && data.is_verified) {
          const img = document.createElement('img');
          img.src = VERIFIED_IMG_URL;
          img.alt = 'موثق';
          img.title = 'موثق';
          img.className = 'verified-badge-img';
          ph.replaceWith(img);
        } else {
          ph.remove();
        }
      } catch (e) {
        ph.remove();
      }
    }));
  }

  // initial load
  document.addEventListener('DOMContentLoaded', () => {
    loadAllUsers();
    updateFriendReqBadge();
  });
</script>
</body>
</html>
