<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول — Aite</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/a/a0/Sond_skyline_from_top_City_Hall_-_Aug_2025.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(57, 130, 247, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(120, 50, 220, 0.1) 0%, transparent 20%);
            color: #e4e6eb;
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        .input-group input {
            background: rgba(45, 45, 45, 0.5) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            transition: all 0.3s ease;
        }
        .input-password-safe {
            padding-left: 45px !important;
        }
        .input-group input:focus {
            border-color: #3982f7 !important;
            background: rgba(45, 45, 45, 0.8) !important;
            box-shadow: 0 0 0 2px rgba(57, 130, 247, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3982f7 0%, #2b61b8 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(57, 130, 247, 0.3);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .eye-btn {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            z-index: 10;
        }
        .error-box { background: rgba(255,0,0,0.06); border: 1px solid rgba(255,0,0,0.12); padding: 8px; border-radius: 8px; color: #ffdddd; display: none; margin-bottom: 12px;}
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="glass-card w-full max-w-md rounded-3xl p-8 md:p-10">
        
        <div class="text-center mb-6">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a0/Sond_skyline_from_top_City_Hall_-_Aug_2025.jpg" 
                 class="h-14 w-14 rounded-xl mx-auto mb-4 object-cover shadow-lg shadow-blue-500/20" 
                 alt="شعار Aite">
            <h1 class="text-4xl font-black tracking-tighter mb-2 bg-gradient-to-br from-white to-gray-500 bg-clip-text text-transparent">Aite</h1>
            <p class="text-gray-400 font-medium">مرحباً بعودتك</p>
        </div>

        <div id="errorBox" class="error-box"></div>

        <form action="/login" method="post" id="loginForm" class="space-y-4">
            <div class="input-group space-y-2">
                <label for="id_username" class="text-sm font-medium text-gray-300 mr-1">اسم المستخدم</label>
                <div class="relative">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-500">
                        <i class="fas fa-user"></i>
                    </span>
                    <input type="text" name="username" id="id_username" required 
                           class="w-full pr-11 pl-4 py-3.5 rounded-xl text-white placeholder-gray-500 outline-none focus:ring-0" 
                           placeholder="أدخل اسم المستخدم">
                </div>
            </div>

            <div class="input-group space-y-2">
                <label for="id_password" class="text-sm font-medium text-gray-300 mr-1">كلمة المرور</label>
                <div class="relative">
                    <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-500">
                        <i class="fas fa-lock"></i>
                    </span>
                    <input type="password" name="password" id="id_password" required 
                           class="w-full pr-11 pl-12 py-3.5 rounded-xl text-white placeholder-gray-500 outline-none focus:ring-0 input-password-safe" 
                           placeholder="••••••••">
                    <button type="button" class="eye-btn" onclick="togglePassword('id_password', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <button type="submit" id="loginBtn" class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-2 flex items-center justify-center gap-3">
                <span id="loginBtnText">دخول</span>
                <i id="loginSpinner" class="fas fa-spinner fa-spin hidden"></i>
            </button>
        </form>

        <div class="mt-6 flex flex-col gap-4 text-center">
            <div class="flex items-center gap-4 text-gray-600">
                <div class="h-px flex-1 bg-gray-800"></div>
                <span class="text-xs uppercase tracking-wider font-semibold text-gray-500">أو</span>
                <div class="h-px flex-1 bg-gray-800"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <a href="/register" class="btn-secondary py-3 px-4 rounded-xl text-sm font-medium text-gray-300 flex items-center justify-center gap-2">
                    <i class="fas fa-user-plus text-blue-400"></i> إنشاء حساب
                </a>
                <a href="/accounts" class="btn-secondary py-3 px-4 rounded-xl text-sm font-medium text-gray-300 flex items-center justify-center gap-2">
                    <i class="fas fa-users text-purple-400"></i> تبديل الحساب
                </a>
            </div>
        </div>
    </div>

    <script>
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        const STORAGE_KEY = 'aite_accounts_secure_v2';
        const DEFAULT_PROFILE_PIC = 'https://res.cloudinary.com/duixjs8az/image/upload/v1765009560/post_media/1765009560909-default_profile.png';
        const errorBox = document.getElementById('errorBox');
        const loginBtn = document.getElementById('loginBtn');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginBtnText = document.getElementById('loginBtnText');

        function loadAccounts() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch (e) { return []; }
        }
        function saveAccounts(list) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            errorBox.style.display = 'none';
            errorBox.textContent = '';

            const username = document.getElementById('id_username').value.trim();
            const password = document.getElementById('id_password').value;

            if (!username || !password) {
                showError('اسم المستخدم وكلمة المرور مطلوبان.');
                return;
            }

            // show loading
            loginBtn.disabled = true;
            loginSpinner.classList.remove('hidden');
            loginBtnText.textContent = 'جاري تسجيل الدخول...';

            try {
                // Send credentials via JSON - server responds with JSON when Accept includes application/json
                const resp = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await resp.json().catch(() => ({ ok: false, error: 'فشل في الاتصال بالخادم' }));

                if (!data.ok) {
                    showError(data.error || 'فشل في تسجيل الدخول.');
                    loginBtn.disabled = false;
                    loginSpinner.classList.add('hidden');
                    loginBtnText.textContent = 'دخول';
                    return;
                }

                // fetch public info (server side) to save after successful login
                let fullName = username;
                let profilePic = DEFAULT_PROFILE_PIC;
                try {
                    const infoResp = await fetch(`/api/get-public-info?username=${encodeURIComponent(username)}`, { credentials: 'include' });
                    if (infoResp.ok) {
                        const infoData = await infoResp.json();
                        if (infoData && infoData.found) {
                            fullName = infoData.full_name || fullName;
                            if (infoData.profile_picture_url && infoData.profile_picture_url.trim() !== '') {
                                profilePic = infoData.profile_picture_url;
                            }
                        }
                    }
                } catch (err) {
                    // ignore - we will still save username
                }

                // save to localStorage AFTER successful server login
                const encryptedPass = btoa(password);
                let accounts = loadAccounts().filter(a => a.username !== username);
                accounts.unshift({
                    username: username,
                    full_name: fullName,
                    profile_picture_url: profilePic,
                    auth_token: encryptedPass
                });
                saveAccounts(accounts.slice(0, 8));

                // redirect to server-provided redirect or default
                window.location.href = data.redirect || '/chat_list';

            } catch (error) {
                console.error("Error saving account:", error);
                showError('فشل في الاتصال بالخادم.');
                loginBtn.disabled = false;
                loginSpinner.classList.add('hidden');
                loginBtnText.textContent = 'دخول';
            }
        });

        function showError(msg) {
            errorBox.style.display = 'block';
            errorBox.textContent = msg;
        }
    </script>
</body>
</html>
