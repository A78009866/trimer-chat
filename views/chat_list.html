<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aite - الصفحة الرئيسية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" href="https://res.cloudinary.com/duixjs8az/image/upload/v1765127215/post_media/1765127215249-trimer.jpg" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Vibes&display=swap" rel="stylesheet">
    
    <!-- استيراد نظام المنشورات -->
    <link rel="import" href="/post.html">
    
    <style>
        /* أنماط خاصة بالصفحة الرئيسية فقط */
        body {
            background-color: #000000;
            color: #e4e6eb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        .glass-navbar {
            background-color: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .app-logo { font-family: 'Montserrat', sans-serif; font-weight: 800; }

        .glass-dropdown {
            background-color: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        /* Families Section */
        .families-row {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 12px;
            -webkit-overflow-scrolling: touch;
        }
        .families-row::-webkit-scrollbar { height: 8px; }
        .families-row::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 8px; }

        .family-card, .create-family-card {
            min-width: 220px;
            height: 130px;
            border-radius: 12px;
            background: rgba(20,20,20,0.6);
            border: 1px solid rgba(255,255,255,0.06);
            display: flex;
            gap: 10px;
            padding: 12px;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }
        .family-card img, .create-family-card {
            width: 88px; height: 88px; border-radius: 12px; object-fit: cover;
        }
        .create-family-card {
            background-size: cover;
            background-position: center;
            justify-content: center;
            color: white;
            position: relative;
        }
        .create-family-card .overlay {
            position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.5));
        }

        /* Reels */
        .reels-scroll-container {
            display: flex;
            gap: 14px;
            overflow-x: auto;
            padding: 14px 6px;
            margin: 14px 0;
        }
        .reel-card-item {
            width: 170px; height: 260px;
            border-radius: 14px;
            background: #111;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.08);
            flex-shrink: 0;
        }
        .reel-card-item img { width: 100%; height: 100%; object-fit: cover; }

        /* Bottom Nav */
        .glass-bottom-navbar {
            background-color: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }

        /* Badges */
        #notifBadge, #msgBadge, #friendReqBadge {
            position: absolute;
            top: -6px; left: -6px;
            min-width: 18px; height: 18px;
            padding: 0 6px;
            background: #ef4444;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-with-dot { position: relative; display: inline-flex; }
        .online-dot {
            position: absolute;
            bottom: 2px; right: 2px;
            width: 12px; height: 12px;
            background: #22c55e;
            border: 2px solid #000;
            border-radius: 999px;
        }

        /* Header Actions */
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .header-actions .action-btn {
            background: rgba(255,255,255,0.04);
            color: #e6eefb;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
        }

        /* Create Modal */
        #createModal .glass-comment-modal-content {
            background: rgba(30,30,30,0.9);
            border-radius: 16px;
            max-width: 400px;
        }
        .create-option-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .create-option-card:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-5px);
        }
    </style>
</head>
<body>

<header class="sticky top-0 z-50 glass-navbar p-3">
    <nav class="flex justify-between items-center max-w-6xl mx-auto">
        <div class="relative group z-[60]"> 
            <button id="profileMenuButton" onclick="toggleProfileDropdown(event)">
                <span class="avatar-with-dot">
                    <img id="userProfilePic" src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full border-2 border-blue-500 object-cover">
                    <span id="meOnlineDot" class="online-dot hidden"></span>
                </span>
            </button>
            <div id="profileDropdown" class="absolute top-12 right-0 mt-2 w-52 rounded-xl glass-dropdown hidden">
                <a href="/profile" class="flex items-center px-4 py-3 text-white hover:bg-white/10">
                    <i class="fas fa-user text-blue-400 ml-3"></i>
                    <span>الملف الشخصي</span>
                </a>
                <a href="/settings" class="flex items-center px-4 py-3 text-white hover:bg-white/10 border-t border-gray-800">
                    <i class="fas fa-cog text-gray-400 ml-3"></i>
                    <span>الإعدادات</span>
                </a>
            </div>
        </div>

        <a href="/chat_list" class="text-3xl font-extrabold text-white tracking-widest app-logo">Aite</a>

        <div class="header-actions">
            <button onclick="window.location.href='/search'" class="action-btn">
                <i class="fas fa-search text-xl"></i>
            </button>
            <button onclick="toggleCreateModal()" class="action-btn">
                <i class="fas fa-plus text-xl"></i>
            </button>
        </div>
    </nav>
</header>

<main class="max-w-6xl mx-auto p-4">
    <!-- Families Section -->
    <div class="max-w-xl mx-auto mt-4">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-white font-bold">العائلات</h2>
            <button onclick="window.location.href='/families'" class="text-sm text-gray-400 hover:text-white">عرض الكل</button>
        </div>
        <div id="familiesRow" class="families-row"></div>
    </div>

    <!-- Reels Section -->
    <div id="reelsSection" class="max-w-xl mx-auto mt-4"></div>

    <!-- Posts Feed -->
    <div id="postsFeed" class="max-w-xl mx-auto mt-6 space-y-4"></div>
</main>

<!-- Bottom Navigation -->
<nav class="glass-bottom-navbar h-14">
    <div class="flex justify-around items-center max-w-lg mx-auto h-full">
        <a href="/chat_list" class="flex flex-col items-center text-blue-400">
            <i class="fas fa-home text-xl"></i>
        </a>
        <a href="/users_list" class="flex flex-col items-center text-gray-400 hover:text-white relative">
            <i class="fas fa-comment-dots text-xl"></i>
            <span id="msgBadge" class="hidden">0</span>
        </a>
        <a href="/reels" class="flex flex-col items-center text-gray-400 hover:text-white">
            <i class="fas fa-clapperboard text-xl"></i>
        </a>
        <a href="/notifications" class="flex flex-col items-center text-gray-400 hover:text-white relative">
            <i class="fas fa-bell text-xl"></i>
            <span id="notifBadge" class="hidden">0</span>
        </a>
        <a href="/all_users" class="flex flex-col items-center text-gray-400 hover:text-white relative">
            <i class="fas fa-users text-xl"></i>
            <span id="friendReqBadge" class="hidden">0</span>
        </a>
    </div>
</nav>

<!-- Create Modal -->
<div id="createModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4" style="background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);" onclick="toggleCreateModal()">
    <div class="p-8 rounded-3xl shadow-2xl max-w-sm w-full border border-white/20" style="background: rgba(30,30,30,0.9);" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-bold text-white">ماذا تريد أن تنشر؟</h3>
            <button onclick="toggleCreateModal()" class="text-gray-400 hover:text-white text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="grid grid-cols-1 gap-4">
            <a href="/create-post" class="create-option-card flex items-center p-5 rounded-2xl">
                <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center ml-4">
                    <i class="fas fa-file-alt text-blue-400 text-xl"></i>
                </div>
                <div>
                    <span class="block text-white font-bold text-lg">منشور جديد</span>
                    <span class="block text-gray-400 text-sm">شارك أفكارك وصورك</span>
                </div>
            </a>
            <a href="/create-reel" class="create-option-card flex items-center p-5 rounded-2xl">
                <div class="w-12 h-12 bg-purple-500/20 rounded-full flex items-center justify-center ml-4">
                    <i class="fas fa-video text-purple-400 text-xl"></i>
                </div>
                <div>
                    <span class="block text-white font-bold text-lg">ريلز</span>
                    <span class="block text-gray-400 text-sm">فيديو قصير</span>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- Family Join Modal -->
<div id="familyJoinModal" class="hidden fixed inset-0 z-60 flex items-center justify-center p-4" style="background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);">
    <div class="bg-[#0f1724] max-w-md w-full rounded-xl p-6 border border-gray-700">
        <h3 class="text-lg font-bold text-white mb-4">الانضمام إلى العائلة</h3>
        <input id="familyJoinInput" class="w-full p-3 rounded-lg bg-[#081019] border border-gray-700 text-white mb-3" placeholder="رمز العائلة">
        <div class="flex gap-3">
            <button onclick="confirmJoinFamily()" class="flex-1 p-3 bg-blue-600 rounded-lg text-white">انضم الآن</button>
            <button onclick="closeJoinModal()" class="flex-1 p-3 bg-gray-700 rounded-lg text-white">إلغاء</button>
        </div>
    </div>
</div>

<script>
// ==================== دوال مساعدة ====================

function toggleProfileDropdown(e) {
    e.stopPropagation();
    document.getElementById('profileDropdown').classList.toggle('hidden');
}

document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('profileDropdown');
    const button = document.getElementById('profileMenuButton');
    if (dropdown && !dropdown.classList.contains('hidden')) {
        if (!button.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    }
});

function toggleCreateModal() {
    const modal = document.getElementById('createModal');
    modal.classList.toggle('hidden');
    document.body.style.overflow = modal.classList.contains('hidden') ? 'auto' : 'hidden';
}

// ==================== Families ====================

const DEFAULT_FAM_IMG = "https://plus.unsplash.com/premium_vector-1682298522309-88e4dc1ccc4d?q=80&w=1125&auto=format&fit=crop";

async function loadFamilies() {
    const container = document.getElementById('familiesRow');
    
    try {
        const res = await fetch('/api/families', { credentials: 'same-origin' });
        const data = await res.json();
        
        let html = `
            <div class="create-family-card" style="background-image: url('${DEFAULT_FAM_IMG}');" onclick="window.location.href='/create-family'">
                <div class="overlay"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold">إنشاء عائلة</div>
                    <div class="text-xs text-gray-200 mt-1">بناء مساحة خاصة</div>
                </div>
            </div>
        `;
        
        if (data.ok && data.families) {
            html += data.families.map(f => `
                <div class="family-card" onclick="onFamilyClick('${f.familyId || f.id}', ${f.is_member})">
                    <img src="${f.imageUrl && !f.imageUrl.includes('placeholder') ? f.imageUrl : DEFAULT_FAM_IMG}" 
                        onerror="this.src='${DEFAULT_FAM_IMG}'">
                    <div>
                        <div class="font-bold text-white whitespace-nowrap overflow-hidden">${f.name}</div>
                        <div class="text-xs text-gray-400 mt-1">${f.membersCount || 0} عضو</div>
                    </div>
                </div>
            `).join('');
        }
        
        container.innerHTML = html;
    } catch (e) {
        console.error('Failed to load families', e);
    }
}

function onFamilyClick(id, isMember) {
    if (isMember) {
        window.location.href = `/family/${id}`;
    } else {
        document.getElementById('familyJoinModal').classList.remove('hidden');
    }
}

function closeJoinModal() {
    document.getElementById('familyJoinModal').classList.add('hidden');
}

async function confirmJoinFamily() {
    // تنفيذ الانضمام للعائلة
}

// ==================== Reels ====================

async function loadReels() {
    try {
        const res = await fetch('/api/reels/feed', { credentials: 'include' });
        const data = await res.json();
        
        if (!data.ok || !data.reels?.length) return;
        
        // خلط عشوائي
        const reels = data.reels.sort(() => Math.random() - 0.5);
        
        const html = `
            <div class="flex items-center gap-2 mb-2 px-2">
                <i class="fas fa-clapperboard text-pink-500"></i>
                <span class="font-bold text-white text-sm">ريلز مقترحة</span>
            </div>
            <div class="reels-scroll-container">
                ${reels.slice(0, 5).map(r => `
                    <div class="reel-card-item" onclick="window.location.href='/reels?id=${r.reelId}'">
                        <img src="${r.thumbnailUrl || r.posterUrl || ''}" 
                            onerror="this.style.background='#000'">
                        <div class="absolute top-2 left-2 w-8 h-8 rounded-full border-2 border-white overflow-hidden">
                            <img src="${r.user?.profile_picture_url || ''}" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/80 to-transparent">
                            <span class="text-white text-xs font-bold">@${r.user?.username || 'user'}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        document.getElementById('reelsSection').innerHTML = html;
    } catch (e) {
        console.error('Failed to load reels', e);
    }
}

// ==================== Posts (باستخدام PostSystem) ====================

async function loadPosts() {
    const container = document.getElementById('postsFeed');
    container.innerHTML = '<div class="text-center text-gray-500 p-4"><i class="fas fa-spinner fa-spin mr-2"></i> جاري التحميل...</div>';
    
    try {
        const res = await fetch('/api/posts', { credentials: 'same-origin' });
        const data = await res.json();
        
        if (!data.ok) {
            container.innerHTML = '<div class="text-center text-red-500 p-4">فشل تحميل المنشورات</div>';
            return;
        }
        
        const posts = (data.posts || []).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        if (!posts.length) {
            container.innerHTML = '<div class="text-center text-gray-500 p-4">لا توجد منشورات بعد</div>';
            return;
        }
        
        container.innerHTML = '';
        const audioPosts = [];
        
        // جلب بيانات التوثيق للمستخدمين
        const userIds = [...new Set(posts.map(p => p.userId))];
        const verifiedMap = {};
        
        await Promise.all(userIds.map(async (uid) => {
            try {
                const r = await fetch(`/api/profile?userId=${uid}`, { credentials: 'same-origin' });
                const u = await r.json();
                if (u.ok) verifiedMap[uid] = u.is_verified;
            } catch (e) {}
        }));
        
        posts.forEach((post, index) => {
            // إضافة بيانات التوثيق
            post.user = post.user || {};
            post.user.is_verified = verifiedMap[post.userId] || post.user.is_verified;
            
            // إنشاء المنشور باستخدام PostSystem
            const postEl = PostSystem.render(post);
            container.appendChild(postEl);
            
            // تتبع المنشورات الصوتية للتهيئة
            if (post.media?.type === 'audio') {
                audioPosts.push({ id: post.postId, url: post.media.url });
            }
        });
        
        // تهيئة مشغلات الصوت
        setTimeout(() => {
            audioPosts.forEach(p => PostSystem.initAudio(p.id, p.url));
        }, 100);
        
    } catch (e) {
        console.error('Failed to load posts', e);
        container.innerHTML = '<div class="text-center text-red-500 p-4">خطأ في الاتصال</div>';
    }
}

// ==================== Badges & Notifications ====================

async function loadBadges() {
    try {
        // الإشعارات
        const notifRes = await fetch('/api/notifications/unread_count', { credentials: 'same-origin' });
        const notifData = await notifRes.json();
        if (notifData.ok && notifData.unread_count > 0) {
            const badge = document.getElementById('notifBadge');
            badge.textContent = notifData.unread_count > 99 ? '99+' : notifData.unread_count;
            badge.classList.remove('hidden');
        }
        
        // الرسائل
        const chatsRes = await fetch('/api/chats', { credentials: 'same-origin' });
        const chatsData = await chatsRes.json();
        if (chatsData.ok && chatsData.chats) {
            const unread = chatsData.chats.reduce((a, c) => a + (c.unread_count || 0), 0);
            if (unread > 0) {
                const badge = document.getElementById('msgBadge');
                badge.textContent = unread > 99 ? '99+' : unread;
                badge.classList.remove('hidden');
            }
        }
        
        // طلبات الصداقة
        const frRes = await fetch('/api/friends/requests_count', { credentials: 'same-origin' });
        const frData = await frRes.json();
        if (frData.ok && frData.count > 0) {
            const badge = document.getElementById('friendReqBadge');
            badge.textContent = frData.count > 99 ? '99+' : frData.count;
            badge.classList.remove('hidden');
        }
    } catch (e) {
        console.error('Failed to load badges', e);
    }
}

// ==================== التهيئة ====================

document.addEventListener('DOMContentLoaded', () => {
    // تهيئة PostSystem
    PostSystem.init();
    
    // تحميل البيانات
    loadFamilies();
    loadReels();
    loadPosts();
    loadBadges();
    
    // تحديث صورة المستخدم
    fetch('/api/profile', { credentials: 'same-origin' })
        .then(r => r.ok ? r.json() : null)
        .then(user => {
            if (user?.profile_picture_url) {
                document.getElementById('userProfilePic').src = user.profile_picture_url;
            }
            if (user?.is_online) {
                document.getElementById('meOnlineDot').classList.remove('hidden');
            }
        });
    
    // Heartbeat
    setInterval(() => {
        fetch('/api/status/heartbeat', { method: 'POST', credentials: 'same-origin' });
    }, 60000);
});
</script>

</body>
</html>
