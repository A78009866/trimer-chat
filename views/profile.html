<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Aite - الملف الشخصي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Vibes&display=swap" rel="stylesheet">
    
    <!-- Import Post Card Component -->
    <link rel="import" href="/post-card.html">
    
    <style>
        body {
            background-color: #000000;
            color: #e4e6eb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-bottom: 60px;
        }

        .glass-navbar {
            background-color: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-logo {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
        }

        .glass-dropdown {
            background-color: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .glass-profile-card {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .modal-animate-in {
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Avatar wrapper */
        .avatar-wrapper {
            position: relative;
            display: inline-block;
            line-height: 0;
        }

        .status-indicator {
            position: absolute;
            background-color: #22c55e;
            border-radius: 50%;
            display: none;
            z-index: 10;
        }

        .status-indicator.large {
            width: 24px;
            height: 24px;
            bottom: 12px;
            left: 5px; 
            border: 4px solid #000000;
        }

        .status-indicator.small {
            width: 13px;
            height: 13px;
            bottom: 0px;
            left: 0px;
            border: 2px solid #242526;
        }

        #profileStatus {
          display: block;
          margin-top: 6px;
          color: #9ca3af;
          font-size: 13px;
        }

        /* Friend buttons */
        .action-btn {
            padding:8px 10px;
            border-radius:10px;
            border:1px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.02);
            color:#e6eefb;
            cursor:pointer;
            font-weight:700;
            transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
        }
        .action-btn:hover { transform: translateY(-2px); background: rgba(255,255,255,0.04); }
        .action-btn:active { transform: translateY(-1px); }

        #chatButton.action-btn.message,
        .action-btn.message {
          background: #1fd14f;
          color: #ffffff;
          padding: 9px 12px;
          font-size: 15px;
          font-weight: 700;
          border-radius: 16px;
          border: none;
          box-shadow: 0 6px 18px rgba(31,209,79,0.12);
          display: inline-flex;
          align-items: center;
          gap: 8px;
          transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
        }
        #chatButton.action-btn.message:hover,
        .action-btn.message:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 26px rgba(31,209,79,0.16);
          background: #19c24a;
        }

        .btn-accept { background: #16a34a; color: #fff; padding: 6px 10px; font-size: 13px; border-radius: 12px; border: none; font-weight:700; }
        .btn-reject { background: #ef4444; color: #fff; padding: 6px 10px; font-size: 13px; border-radius: 12px; border: none; font-weight:700; }

        @media (max-width:480px) {
          .action-btn.message, .btn-accept, .btn-reject { padding:5px 8px; font-size:12px; border-radius:10px; }
        }

        /* Toast container */
        #toastContainer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="sticky top-0 z-50 glass-navbar p-3">
        <nav class="flex justify-between items-center max-w-6xl mx-auto relative">
            <div class="flex items-center">
                <a href="/chat_list" class="text-gray-400 hover:text-white transition duration-300">
                    <i class="fas fa-arrow-right text-2xl"></i>
                </a>
            </div>

            <div class="flex-grow flex justify-center">
                <a href="/chat_list" class="text-3xl font-extrabold text-white tracking-widest hover:text-gray-300 transition duration-300 app-logo">
                    Aite
                </a>
            </div>

            <div class="flex items-center space-x-4 space-x-reverse relative">
                <button id="profileMenuButton" class="relative block" onclick="toggleProfileDropdown(event)">
                    <img id="userProfilePic" src="https://res.cloudinary.com/duixjs8az/image/upload/v1765009560/post_media/1765009560909-default_profile.png" alt="صورة P" class="w-10 h-10 rounded-full border-2 border-blue-500 object-cover hover:ring-2 hover:ring-blue-400 transition duration-300 cursor-pointer">
                </button>
            </div>

            <div id="profileDropdown" class="absolute top-14 left-0 mt-2 w-48 rounded-lg shadow-xl glass-dropdown hidden">
                <a href="/profile" class="flex items-center px-4 py-3 text-white hover:bg-white/10 rounded-t-lg transition duration-200">
                    <i class="fas fa-user-circle text-xl ml-3"></i>
                    الملف الشخصي
                </a>
                <a href="/logout" class="flex items-center px-4 py-3 text-red-400 hover:bg-white/10 rounded-b-lg transition duration-200 border-t border-gray-700">
                    <i class="fas fa-sign-out-alt text-xl ml-3"></i>
                    تسجيل الخروج
                </a>
            </div>
        </nav>
    </header>

    <main class="max-w-6xl mx-auto p-4">
        <div class="max-w-xl mx-auto">

            <div id="profileCard" class="glass-profile-card rounded-xl shadow-2xl p-0 overflow-hidden mb-4 animate-fadeIn">

                <div id="coverPhotoContainer" class="w-full h-40 bg-gray-900 relative"
                     style="background-image: url('/assets/default_cover_photo.jpg'); background-size: cover; background-position: center;">
                    <div class="absolute inset-0 bg-black/30"></div>
                </div>

                <div class="p-4 pt-0 -mt-20 relative">

                    <div id="profileAvatarWrap" class="avatar-wrapper" data-user-id="">
                        <img id="profileImage" src="https://res.cloudinary.com/duixjs8az/image/upload/v1765009560/post_media/1765009560909-default_profile.png" alt="صورة الملف الشخصي"
                             class="w-32 h-32 rounded-full object-cover border-4 border-black shadow-lg mb-3 hover:ring-4 hover:ring-blue-400 transition duration-300">
                        
                        <span id="profileOnlineDot" class="status-indicator large" title="متصل الآن"></span>
                    </div>

                    <div class="flex justify-between items-start">
                        <div>
                            <h1 id="profileUsername" class="text-3xl font-bold text-white">تحميل...</h1>
                            <p id="profileFullName" class="text-gray-400 text-lg">الاسم الكامل</p>
                            <span id="profileStatus" class="">...</span>
                            <p id="profileBio" class="text-gray-300 mt-1 whitespace-pre-wrap">السيرة الذاتية...</p>
                        </div>

                        <div class="flex flex-col items-end gap-2">
                            <a id="editProfileButton" href="/edit_profile"
                               class="hidden bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-4 rounded-lg transition duration-300 flex items-center text-sm shadow-md">
                                تعديل
                            </a>

                            <a id="chatButton" href="#" class="action-btn message" style="display:none">
                                <i class="fas fa-comment-dots ml-2"></i>
                                مراسلة
                            </a>

                            <div id="friendActionContainer" class="flex gap-2">
                                </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="userPostsFeed" class="space-y-4">
                <div class="text-center text-gray-500 p-8"><i class="fas fa-spinner fa-spin ml-2"></i> جاري تحميل المنشورات...</div>
            </div>

        </div>
    </main>

    <!-- Toast container -->
    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <!-- Include Post Card Component -->
    <iframe src="/post-card.html" style="display:none;" onload="this.contentDocument.body.innerHTML && document.body.insertAdjacentHTML('beforeend', this.contentDocument.body.innerHTML)"></iframe>

<script>
const VERIFIED_IMG_URL = "https://res.cloudinary.com/duixjs8az/image/upload/v1768036959/post_media/1768036959482-badge.png";
const DEFAULT_PROFILE_PIC_URL = 'https://res.cloudinary.com/duixjs8az/image/upload/v1765009560/post_media/1765009560909-default_profile.png';

let currentProfileId = null;
let currentUserId = null;
let PROFILE_VERIFIED = false; 
let statusPollInterval = null;

/* ---------------- Toast helper ---------------- */
function showToast(message, opts = {}) {
    const { type = 'info', duration = 3500 } = opts;
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.setAttribute('role', 'status');
    toast.innerHTML = `
        <i class="${type === 'success' ? 'fas fa-check-circle' : (type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle')}"></i>
        <div class="msg">${escapeHtml(message)}</div>
        <button class="close-btn" aria-label="close">&times;</button>
    `;

    const closeBtn = toast.querySelector('.close-btn');
    const removeToast = () => {
        toast.style.transition = 'transform .18s cubic-bezier(.2,.8,.2,1), opacity .18s';
        toast.style.transform = 'translateY(-10px)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 200);
    };
    closeBtn.addEventListener('click', removeToast);

    container.appendChild(toast);

    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-10px)';
    requestAnimationFrame(() => {
        toast.style.transition = 'transform .18s cubic-bezier(.2,.8,.2,1), opacity .18s';
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
    });

    const t = setTimeout(() => {
        removeToast();
    }, duration);

    toast.addEventListener('mouseenter', () => clearTimeout(t));
}

/* ---------------- UI helpers ---------------- */
function toggleProfileDropdown(event) {
    event.stopPropagation();
    const profileDropdown = document.getElementById('profileDropdown');
    profileDropdown.classList.toggle('hidden');
}

document.addEventListener('click', (event) => {
    const profileDropdown = document.getElementById('profileDropdown');
    const profileMenuButton = document.getElementById('profileMenuButton');
    if (profileDropdown && !profileDropdown.contains(event.target) && !profileMenuButton.contains(event.target)) {
        profileDropdown.classList.add('hidden');
    }
});

function formatTimestamp(timestamp) {
    const date = new Date(Number(timestamp));
    const now = new Date();
    const diffInHours = (now - date) / (1000 * 60 * 60);
    if (diffInHours < 24) {
        return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    } else if (diffInHours < 7 * 24) {
        return date.toLocaleDateString('ar-EG', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
    } else {
        return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
    }
}

/* ---------------- Media viewer ---------------- */
function openMediaViewer(url, type, event) {
    event.stopPropagation();
    const modal = document.getElementById('mediaViewerModal');
    const content = document.getElementById('mediaViewerContent');
    content.innerHTML = '';
    
    if (type === 'image') {
        content.innerHTML = `<img src="${url}" alt="Media Viewer" class="max-w-full max-h-full object-contain rounded-lg">`;
    }

    modal.classList.remove('hidden');
}

function closeMediaViewer(event) {
    if (event && (event.target.id === 'mediaViewerModal' || event.target.closest('.fa-times'))) {
        const content = document.getElementById('mediaViewerContent');
        const activeMedia = content.querySelector('video, audio');
        if (activeMedia) activeMedia.pause();
        document.getElementById('mediaViewerModal').classList.add('hidden');
        content.innerHTML = '';
    }
}

/* ---------------- Fetch & display user posts ---------------- */
async function fetchAndDisplayUserPosts(userId) {
    const userPostsFeed = document.getElementById('userPostsFeed');
    userPostsFeed.innerHTML = '<div class="text-center text-gray-500 p-8"><i class="fas fa-spinner fa-spin ml-2"></i> جاري تحميل المنشورات...</div>';

    try {
        const response = await fetch(`/api/posts/user/${encodeURIComponent(userId)}`, { credentials: 'same-origin' });
        const result = await response.json();

        userPostsFeed.innerHTML = '';

        if (response.ok && result.ok) {
            if (result.posts.length === 0) {
                userPostsFeed.innerHTML = '<div class="text-center text-gray-500 p-8">لا توجد منشورات لعرضها بعد.</div>';
            } else {
                const audioPostsToInit = [];
                result.posts.forEach(post => {
                    post.user = post.user || {};
                    if (typeof post.user.is_verified === 'undefined') post.user.is_verified = !!PROFILE_VERIFIED;

                    userPostsFeed.innerHTML += createPostCard(post);
                    if (post.media && post.media.type === 'audio') audioPostsToInit.push({ postId: post.postId, url: post.media.url });
                });
                setTimeout(() => {
                    audioPostsToInit.forEach(ap => initializePostWaveSurfer(ap.postId, ap.url));
                    setupShowMoreButtons();
                }, 100);

                startStatusPolling();
            }
        } else {
            userPostsFeed.innerHTML = '<div class="text-center text-red-500 p-8">فشل في جلب المنشورات.</div>';
        }
    } catch (error) {
        console.error('Error fetching user posts:', error);
        userPostsFeed.innerHTML = '<div class="text-center text-red-500 p-8">حدث خطأ في الاتصال بالخادم.</div>';
    }
}

/* ---------------- Fetch & profile logic ---------------- */
async function fetchCurrentUser() {
    try {
        const resp = await fetch('/api/profile', { credentials: 'same-origin' });
        if (!resp.ok) return;
        const data = await resp.json();
        if (data && data.id) {
            currentUserId = data.id;
            postCardCurrentUserId = data.id;
            const smallPic = document.getElementById('userProfilePic');
            if (smallPic) smallPic.src = data.profile_picture_url || DEFAULT_PROFILE_PIC_URL;
        }
    } catch (e) {
        console.error('fetchCurrentUser failed', e);
    }
}

async function fetchAndDisplayProfile() {
    await fetchCurrentUser();

    const urlParams = new URLSearchParams(window.location.search);
    const requestedUserId = urlParams.get('userId');
    currentProfileId = requestedUserId || currentUserId;
    if (!currentProfileId) {
        document.getElementById('userPostsFeed').innerHTML = '<div class="text-center text-red-500 p-8">خطأ: لا يمكن تحديد الملف الشخصي.</div>';
        return;
    }

    try {
        const response = await fetch(`/api/profile?userId=${encodeURIComponent(currentProfileId)}`, { credentials: 'same-origin' });
        const data = await response.json();

        if (response.ok && data.ok) {
            PROFILE_VERIFIED = !!data.is_verified;

            const profileAvatarWrap = document.getElementById('profileAvatarWrap');
            profileAvatarWrap.dataset.userId = data.id;

            document.getElementById('profileImage').src = data.profile_picture_url || DEFAULT_PROFILE_PIC_URL;
            if (data.cover_photo_url) document.getElementById('coverPhotoContainer').style.backgroundImage = `url('${data.cover_photo_url}')`;

            const profileUsernameEl = document.getElementById('profileUsername');
            profileUsernameEl.innerHTML = `@${data.username}` + (data.is_verified ? ` <img src="${VERIFIED_IMG_URL}" class="verified-badge-img list" alt="موثق" title="موثق">` : '');

            document.getElementById('profileFullName').textContent = data.full_name || 'لا يوجد اسم كامل';
            document.getElementById('profileBio').textContent = data.bio || '';
            document.getElementById('pageTitle').textContent = `Aite - @${data.username}`;

            setUserOnlineUI(data.id, !!data.is_online, data.last_seen);

            const friendActionContainer = document.getElementById('friendActionContainer');
            friendActionContainer.innerHTML = '';
            const editProfileButton = document.getElementById('editProfileButton');
            const chatButton = document.getElementById('chatButton');

            if (chatButton) {
                chatButton.style.display = 'none';
                chatButton.href = '#';
            }

            if (currentUserId && data.id === currentUserId) {
                editProfileButton.classList.remove('hidden');
                if (chatButton) chatButton.style.display = 'none';
            } else {
                editProfileButton.classList.add('hidden');

                if (data.is_friend) {
                    if (chatButton) {
                        chatButton.href = `/chat?contactId=${currentProfileId}`;
                        chatButton.classList.remove('hidden');
                        chatButton.style.display = 'inline-flex';
                    }
                } else {
                    if (chatButton) {
                        chatButton.classList.add('hidden');
                        chatButton.style.display = 'none';
                    }
                }

                if (data.request_received) {
                    friendActionContainer.innerHTML = `
                      <button id="acceptFriendBtn" class="btn-accept"><i class="fas fa-user-check ml-2"></i>قبول</button>
                      <button id="rejectFriendBtn" class="btn-reject"><i class="fas fa-times ml-2"></i>رفض</button>
                    `;
                    document.getElementById('acceptFriendBtn').addEventListener('click', async () => {
                        try {
                            const r = await fetch('/api/friends/accept', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from_id: currentProfileId })});
                            const j = await r.json();
                            if (r.ok && j.ok) { showToast('تمت الموافقة — أصبح هذا المستخدم صديقك.', { type: 'success' }); fetchAndDisplayProfile(); }
                            else { showToast('فشل في قبول الطلب.', { type: 'error' }); }
                        } catch (e) { showToast('خطأ في الشبكة', { type: 'error' }); }
                    });
                    document.getElementById('rejectFriendBtn').addEventListener('click', async () => {
                        try {
                            const r = await fetch('/api/friends/reject', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from_id: currentProfileId })});
                            const j = await r.json();
                            if (r.ok && j.ok) { showToast('تم رفض الطلب.', { type: 'success' }); fetchAndDisplayProfile(); }
                            else { showToast('فشل في رفض الطلب.', { type: 'error' }); }
                        } catch (e) { showToast('خطأ في الشبكة', { type: 'error' }); }
                    });
                } else if (data.request_sent) {
                    friendActionContainer.innerHTML = `<button id="cancelFriendBtn" class="action-btn"><i class="fas fa-clock ml-2"></i>طلب مرسل</button>`;
                    document.getElementById('cancelFriendBtn').addEventListener('click', async (ev) => {
                        const btn = ev.currentTarget;
                        try {
                            btn.disabled = true;
                            btn.textContent = 'جاري الإلغاء...';
                            const r = await fetch('/api/friends/cancel', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to_id: currentProfileId })});
                            const j = await r.json();
                            if (r.ok && j.ok) { showToast('تم إلغاء الطلب.', { type: 'success' }); fetchAndDisplayProfile(); } else { showToast('فشل في إلغاء الطلب.', { type: 'error' }); fetchAndDisplayProfile(); }
                        } catch (e) { showToast('خطأ في الشبكة', { type: 'error' }); fetchAndDisplayProfile(); }
                    });
                } else if (!data.is_friend) {
                    friendActionContainer.innerHTML = `<button id="addFriendBtn" class="action-btn"><i class="fas fa-user-plus ml-2"></i>إضافة صديق</button>`;
                    document.getElementById('addFriendBtn').addEventListener('click', async (ev) => {
                        const btn = ev.currentTarget;
                        try {
                            btn.disabled = true;
                            btn.textContent = 'جاري الإرسال...';
                            const r = await fetch('/api/friends/request', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to_id: currentProfileId })});
                            const j = await r.json();
                            if (r.ok && j.ok) { showToast('تم إرسال طلب الصداقة.', { type: 'success' }); fetchAndDisplayProfile(); } else { showToast(j.error || 'فشل في إرسال الطلب.', { type: 'error' }); fetchAndDisplayProfile(); }
                        } catch (e) { showToast('خطأ في الشبكة', { type: 'error' }); fetchAndDisplayProfile(); }
                    });
                }
            }
            await fetchAndDisplayUserPosts(currentProfileId);
        } else {
            document.getElementById('userPostsFeed').innerHTML = `<div class="text-center text-red-500 p-8">لم يتم العثور على المستخدم @${currentProfileId}</div>`;
        }
    } catch (error) {
        console.error('Error fetching profile:', error);
        document.getElementById('userPostsFeed').innerHTML = '<div class="text-center text-red-500 p-8">حدث خطأ في جلب بيانات الملف الشخصي.</div>';
    }
}

/* ----------------- Presence & SSE ----------------- */

function setUserOnlineUI(userId, isOnline, lastSeenTs) {
    const selectors = document.querySelectorAll(`.avatar-wrapper[data-user-id="${userId}"]`);
    selectors.forEach(av => {
        const dot = av.querySelector('.status-indicator');
        if (!dot) return;
        if (isOnline) {
            dot.style.display = 'block';
        } else {
            dot.style.display = 'none';
        }
    });

    const profileAvatarWrap = document.getElementById('profileAvatarWrap');
    if (profileAvatarWrap && profileAvatarWrap.dataset.userId === userId) {
        const bigDot = document.getElementById('profileOnlineDot');
        const profileStatus = document.getElementById('profileStatus');
        
        if (isOnline) {
            if (bigDot) bigDot.style.display = 'block';
            if (profileStatus) {
                profileStatus.textContent = 'متصل الآن';
                profileStatus.className = 'text-green-500 font-semibold text-sm block mt-1';
            }
        } else {
            if (bigDot) bigDot.style.display = 'none';
            if (profileStatus) {
                profileStatus.textContent = formatLastSeen(lastSeenTs) || '';
                profileStatus.className = 'text-gray-400 text-sm block mt-1';
            }
        }
    }
}

function formatLastSeen(lastSeenTs) {
    if (!lastSeenTs) return '';
    const now = Date.now();
    const diff = Math.max(0, now - lastSeenTs);
    const seconds = Math.floor(diff / 1000);
    if (seconds < 60) return 'متصل منذ لحظات';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `آخر ظهور منذ ${minutes} دقيقة${minutes > 1 ? 'ً' : ''}`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `آخر ظهور منذ ${hours} ساعة${hours > 1 ? 'ً' : ''}`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `آخر ظهور منذ ${days} يوم${days > 1 ? 'ً' : ''}`;
    const d = new Date(lastSeenTs);
    return `آخر ظهور في ${d.toLocaleDateString('ar-EG')}`;
}

function startStatusPolling() {
    if (statusPollInterval) clearInterval(statusPollInterval);
    pollProfileStatus();
    statusPollInterval = setInterval(pollProfileStatus, 15000); 
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') pollProfileStatus();
    });
    window.addEventListener('beforeunload', () => {
        if (statusPollInterval) clearInterval(statusPollInterval);
    });
}

async function pollProfileStatus() {
    if (!currentProfileId) return;
    try {
        const r = await fetch(`/api/profile?userId=${encodeURIComponent(currentProfileId)}`, { cache: 'no-store' });
        if (!r.ok) return;
        const d = await r.json();
        if (d && d.ok) {
            setUserOnlineUI(currentProfileId, !!d.is_online, d.last_seen);
        }
    } catch (e) {}
}

/* ----------------- Init ----------------- */

document.addEventListener('DOMContentLoaded', () => {
    fetchAndDisplayProfile();
});

/* ----------------- small helpers ----------------- */
function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}
</script>

</body>
</html>
