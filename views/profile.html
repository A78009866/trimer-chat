<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Aite - الملف الشخصي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Vibes&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #000000;
            color: #e4e6eb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-bottom: 60px;
        }

        .glass-navbar {
            background-color: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-logo {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
        }

        .glass-dropdown {
            background-color: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .glass-post-card, .glass-profile-card {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .waveform-post {
            height: 60px; 
            background: #000000; /* fully black */
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.04);
            overflow: hidden;
        }

        /* New wrapper for audio area: make the frame black */
        .audio-play-wrapper {
            background: #000000; /* black frame */
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.04);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Play button: white background, black icon */
        .audio-play-button {
            background: #ffffff;
            color: #000000;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: transform .12s ease, box-shadow .12s ease;
            cursor: pointer;
        }
        .audio-play-button i {
            color: #000000; /* icon black */
        }
        .audio-play-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
        }

        /* Ensure hover doesn't turn play icon blue */
        .audio-play-button:hover i {
            color: #000000 !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .modal-animate-in {
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ---------------------------------------------------------
           تنسيقات نافذة التعليقات الجديدة (Bottom Sheet)
           --------------------------------------------------------- */
        .glass-comment-modal-content {
            background-color: #18191a;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            top: auto; 
            height: 75vh;
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 60;
        }

        .glass-comment-modal-content.open {
            transform: translateY(0);
        }

        @media (min-width: 768px) {
            .glass-comment-modal-content {
                position: relative;
                height: 80vh;
                max-width: 500px;
                margin: 0 auto;
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                transform: scale(0.95);
                opacity: 0;
                transition: all 0.2s ease-out;
            }
            .glass-comment-modal-content.open {
                transform: scale(1);
                opacity: 1;
            }
            #commentModal {
                align-items: center; 
                justify-content: center;
            }
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background-color: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 12px auto 8px auto;
        }
        
        .glass-modal-bg {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: opacity 0.3s;
        }

        .close-btn-circle {
            background: rgba(255,255,255,0.1);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            cursor: pointer;
        }
        .close-btn-circle:hover {
            background: rgba(255,255,255,0.2);
        }

        /* --- تحسينات صور البروفايل ونقاط النشاط --- */
        .avatar-wrapper {
            position: relative;
            display: inline-block;
            line-height: 0;
        }

        .status-indicator {
            position: absolute;
            background-color: #22c55e;
            border-radius: 50%;
            display: none;
            z-index: 10;
        }

        .status-indicator.large {
            width: 24px;
            height: 24px;
            bottom: 12px;
            left: 5px; 
            border: 4px solid #000000;
        }

        .status-indicator.small {
            width: 13px;
            height: 13px;
            bottom: 0px;
            left: 0px;
            border: 2px solid #242526;
        }

        #profileStatus {
          display: block;
          margin-top: 6px;
          color: #9ca3af;
          font-size: 13px;
        }

        .verified-badge-img {
          display: inline-block;
          width: 14px;
          height: 14px;
          border-radius: 50%;
          margin-right: 4px;
          margin-left: 2px;
          object-fit: cover;
          vertical-align: middle;
        }

        /* Comments styles (profile) */
        .comment-item { padding: 10px; border-radius: 12px; background: #111; border: 1px solid #222; }
        .reply-item { margin-right: 36px; margin-top: 6px; background: #0f1416; padding: 6px; border-radius: 10px; border: 1px solid #222; }
        .small-avatar { width: 28px; height: 28px; border-radius: 999px; }

        @media (max-width: 480px) {
           .status-indicator.large { width: 20px; height: 20px; bottom: 12px; left: 4px; border-width: 3px; }
        }

        /* ----------------- Friend buttons (match all_users.html) ----------------- */
        .action-btn {
            padding:8px 10px;
            border-radius:10px;
            border:1px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.02);
            color:#e6eefb;
            cursor:pointer;
            font-weight:700;
            transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
        }
        .action-btn:hover { transform: translateY(-2px); background: rgba(255,255,255,0.04); }
        .action-btn:active { transform: translateY(-1px); }

                /* chat button color fixed to #1fd14f */
        #chatButton.action-btn.message,
        .action-btn.message {
          background: #1fd14f;
          color: #ffffff;
          padding: 9px 12px;
          font-size: 15px;
          font-weight: 700;
          border-radius: 16px;
          border: none;
          box-shadow: 0 6px 18px rgba(31,209,79,0.12);
          display: inline-flex;
          align-items: center;
          gap: 8px;
          transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
        }
        #chatButton.action-btn.message:hover,
        .action-btn.message:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 26px rgba(31,209,79,0.16);
          background: #19c24a;
        }
        #chatButton.action-btn.message:focus,
        .action-btn.message:focus {
          outline: 2px solid rgba(31,209,79,0.18);
          outline-offset: 2px;
        }

        .btn-accept { background: #16a34a; color: #fff; padding: 6px 10px; font-size: 13px; border-radius: 12px; border: none; font-weight:700; }
        .btn-reject { background: #ef4444; color: #fff; padding: 6px 10px; font-size: 13px; border-radius: 12px; border: none; font-weight:700; }

        @media (max-width:480px) {
          .action-btn.message, .btn-accept, .btn-reject { padding:5px 8px; font-size:12px; border-radius:10px; }
        }

        /* Slightly larger verified badge variant for lists */
        .verified-badge-img.list {
          width: 18px;
          height: 18px;
          margin-left: 6px;
        }

        /* ------------------ Toasts (black glassy) ------------------ */
        #toastContainer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            pointer-events: none;
        }
        .toast {
            min-width: 220px;
            max-width: 90vw;
            color: #ffffff;
            background: rgba(7,7,8,0.6);
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 10px 14px;
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: auto;
            font-size: 14px;
        }
        .toast.success { border-left: 4px solid #16a34a; }
        .toast.error   { border-left: 4px solid #ef4444; }
        .toast.info    { border-left: 4px solid #3b82f6; }
        .toast i { width: 18px; text-align: center; }
        .toast .msg { flex: 1; word-break: break-word; text-align: right; }
        .toast .close-btn { margin-left: 8px; background: transparent; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 14px; }

        /* ------------------ Post options bottom sheet (copied/adapted) ------------------ */
        #postOptionsModal .sheet {
          background: #0b0b0c;
          border-radius: 14px 14px 0 0;
          padding: 12px;
          border: 1px solid rgba(255,255,255,0.06);
        }
        .option-btn {
          display:flex;
          align-items:center;
          justify-content:center;
          gap:10px;
          padding:12px;
          border-radius:10px;
          width:100%;
          background: rgba(255,255,255,0.02);
          color:#e6eefb;
          border:1px solid rgba(255,255,255,0.03);
          cursor:pointer;
        }
        .option-btn.danger { background: linear-gradient(90deg,#7f1d1d, #ef4444); color:white; border:none; }
        .option-btn:active { transform: translateY(1px); }
        .option-row { display:flex; gap:10px; margin-bottom:10px; }

        /* --- Video large display (copied from chat_list) --- */
        .video-large {
            width: 100%;
            height: 480px;
            max-height: 72vh;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            position: relative;
            display: block;
        }
        .video-large video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* show video clearly and fill area */
            display: block;
            background: #000;
            cursor: pointer;
        }
        /* central overlay play (bigger, cleaner) */
        .video-play-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15));
            transition: opacity 0.18s;
            z-index: 30;
        }
        .video-play-overlay i {
            font-size: 54px;
            color: rgba(255,255,255,0.94);
            text-shadow: 0 6px 24px rgba(0,0,0,0.6);
        }
        .video-play-overlay.hidden { opacity: 0; pointer-events: none; }

        /* fullscreen button (small) */
        .video-fs-btn {
            position: absolute;
            top: 10px;
            left: 10px; /* left because dir=rtl; visually it's on top-left */
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(0,0,0,0.45);
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            z-index: 40;
            cursor: pointer;
        }
        .video-fs-btn i { font-size: 14px; }

        /* hide the old controls bar to keep the UI minimal */
        [id^="controls-bar-"] { display: none !important; }

    </style>
</head>
<body class="min-h-screen">

    <header class="sticky top-0 z-50 glass-navbar p-3">
        <nav class="flex justify-between items-center max-w-6xl mx-auto relative">
            <div class="flex items-center">
                <a href="/chat_list" class="text-gray-400 hover:text-white transition duration-300">
                    <i class="fas fa-arrow-right text-2xl"></i>
                </a>
            </div>

            <div class="flex-grow flex justify-center">
                <a href="/chat_list" class="text-3xl font-extrabold text-white tracking-widest hover:text-gray-300 transition duration-300 app-logo">
                    Aite
                </a>
            </div>

            <div class="flex items-center space-x-4 space-x-reverse relative">
                <button id="profileMenuButton" class="relative block" onclick="toggleProfileDropdown(event)">
                    <img id="userProfilePic" src="https://res.cloudinary.com/duixjs8az/image/upload/v1765009560/post_media/1765009560909-default_profile.png" alt="صورة P" class="w-10 h-10 rounded-full border-2 border-blue-500 object-cover hover:ring-2 hover:ring-blue-400 transition duration-300 cursor-pointer">
                </button>
            </div>

            <div id="profileDropdown" class="absolute top-14 left-0 mt-2 w-48 rounded-lg shadow-xl glass-dropdown hidden">
                <a href="/profile" class="flex items-center px-4 py-3 text-white hover:bg-white/10 rounded-t-lg transition duration-200">
                    <i class="fas fa-user-circle text-xl ml-3"></i>
                    الملف الشخصي
                </a>
                <a href="/logout" class="flex items-center px-4 py-3 text-red-400 hover:bg-white/10 rounded-b-lg transition duration-200 border-t border-gray-700">
                    <i class="fas fa-sign-out-alt text-xl ml-3"></i>
                    تسجيل الخروج
                </a>
            </div>
        </nav>
    </header>

    <main class="max-w-6xl mx-auto p-4">
        <div class="max-w-xl mx-auto">

            <div id="profileCard" class="glass-profile-card rounded-xl shadow-2xl p-0 overflow-hidden mb-4 animate-fadeIn">

                <div id="coverPhotoContainer" class="w-full h-40 bg-gray-900 relative"
                     style="background-image: url('/assets/default_cover_photo.jpg'); background-size: cover; background-position: center;">
                    <div class="absolute inset-0 bg-black/30"></div>
                </div>

                <div class="p-4 pt-0 -mt-20 relative">

                    <div id="profileAvatarWrap" class="avatar-wrapper" data-user-id="">
                        <img id="profileImage" src="https://res.cloudinary.com/duixjs8az/image/upload/v1765009560/post_media/1765009560909-default_profile.png" alt="صورة الملف الشخصي"
                             class="w-32 h-32 rounded-full object-cover border-4 border-black shadow-lg mb-3 hover:ring-4 hover:ring-blue-400 transition duration-300">
                        
                        <span id="profileOnlineDot" class="status-indicator large" title="متصل الآن"></span>
                    </div>

                    <div class="flex justify-between items-start">
                        <div>
                            <h1 id="profileUsername" class="text-3xl font-bold text-white">تحميل...</h1>
                            <p id="profileFullName" class="text-gray-400 text-lg">الاسم الكامل</p>
                            <span id="profileStatus" class="">...</span>
                            <p id="profileBio" class="text-gray-300 mt-1 whitespace-pre-wrap">السيرة الذاتية...</p>
                        </div>

                        <div class="flex flex-col items-end gap-2">
                            <a id="editProfileButton" href="/edit_profile"
                               class="hidden bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-4 rounded-lg transition duration-300 flex items-center text-sm shadow-md">
                                تعديل
                            </a>

                            <!-- chatButton: will have green #1fd14f from CSS when shown -->
                            <a id="chatButton"
   href="#"
   class="action-btn message" style="display:none">
    <i class="fas fa-comment-dots ml-2"></i>
    مراسلة
</a>

                            <div id="friendActionContainer" class="flex gap-2">
                                </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="userPostsFeed" class="space-y-4">
                <div class="text-center text-gray-500 p-8"><i class="fas fa-spinner fa-spin ml-2"></i> جاري تحميل المنشورات...</div>
            </div>

        </div>
    </main>

    <!-- Centered delete confirmation modal (glass) -->
    <div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 glass-modal-bg">
        <div class="bg-[#1f2937] p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700 text-center" onclick="event.stopPropagation()">
            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">تأكيد الحذف</h3>
            <p class="text-gray-400 mb-6">هل أنت متأكد أنك تريد حذف هذا المنشور؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="flex justify-around space-x-4 space-x-reverse">
                <button id="cancelDeleteBtn" class="p-2 w-full bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition duration-300">إلغاء</button>
                <button id="confirmDeleteBtn" class="p-2 w-full bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-300">تأكيد الحذف</button>
            </div>
            <div id="deleteMessage" class="text-red-500 mt-3 hidden"></div>
        </div>
    </div>

    <div id="mediaViewerModal" class="fixed inset-0 bg-black bg-opacity-90 z-[1000] hidden flex items-center justify-center p-4" onclick="closeMediaViewer()">
        <div class="relative w-full max-w-4xl max-h-full overflow-hidden" onclick="event.stopPropagation()">
            <button class="absolute top-4 right-4 text-white text-3xl z-10 hover:text-gray-300" onclick="closeMediaViewer()">&times;</button>
            <img id="mediaViewerImage" src="" alt="Post Media" class="max-w-full max-h-[90vh] object-contain mx-auto hidden">
            <video id="mediaViewerVideo" src="" controls class="max-w-full max-h-[90vh] object-contain mx-auto hidden"></video>
        </div>
    </div>

    <!-- Post options bottom sheet (NEW - same behaviour as main feed) -->
    <div id="postOptionsModal" class="hidden fixed inset-0 z-[80] flex items-end justify-center glass-modal-bg" onclick="closePostOptionsModal()">
      <div class="sheet w-full md:max-w-md" onclick="event.stopPropagation()">
        <div class="modal-handle" style="margin-bottom:8px;"></div>
        <div class="p-3">
          <div id="postOptionsMessage" class="text-sm text-gray-300 mb-2 hidden"></div>
          <div class="option-row">
            <button id="postOptionsDeleteBtn" class="option-btn danger" onclick="confirmDeleteFromOptions(event)">
              <i class="fas fa-trash"></i>
              <span>حذف المنشور</span>
            </button>
          </div>
          <div class="option-row">
            <button id="postOptionsAddFriendBtn" class="option-btn" onclick="addFriendFromOptions(event)">
              <i class="fas fa-user-plus"></i>
              <span>إضافة صديق</span>
            </button>
          </div>
          <div class="option-row">
            <button id="postOptionsCloseBtn" class="option-btn" onclick="closePostOptionsModal()">
              <i class="fas fa-times"></i>
              <span>إلغاء</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="postMenu" class="absolute z-40 bg-[#242526] rounded-lg shadow-xl border border-gray-700 hidden w-40">
        <button id="deleteOptionBtn" class="flex items-center w-full p-3 text-red-400 hover:bg-[#343536] rounded-lg transition duration-300">
            <i class="fas fa-trash ml-3"></i>
            حذف المنشور
        </button>
    </div>

    <div id="commentModal" class="hidden fixed inset-0 z-50 flex items-end md:items-center justify-center glass-modal-bg transition-opacity duration-300">
        <div id="commentModalContent" class="glass-comment-modal-content w-full md:w-auto" onclick="event.stopPropagation()">
            
            <div class="md:hidden w-full flex justify-center" onclick="closeCommentModal()">
                <div class="modal-handle"></div>
            </div>

            <div class="flex justify-between items-center px-4 pb-2 pt-2 border-b border-gray-800">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    التعليقات 
                    <span id="commentCountBadge" class="text-xs bg-gray-700 px-2 py-0.5 rounded-full text-gray-300">0</span>
                </h3>
                <button id="closeCommentModalBtn" class="close-btn-circle text-gray-300 hover:text-white" onclick="closeCommentModal()">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            
            <div id="commentsList" class="flex-grow overflow-y-auto p-4 space-y-4 custom-scrollbar bg-[#18191a] min-h-0">
                </div>

            <div class="p-3 border-t border-gray-800 bg-[#18191a]">
                <div id="commentError" class="text-red-500 text-xs text-center mb-2 hidden"></div>
                <div class="flex items-center gap-2 bg-[#242526] p-1.5 rounded-3xl border border-gray-700">
                    <img id="myCurrentAvatar" src="" class="w-8 h-8 rounded-full object-cover border border-gray-600 ml-1">
                    <input type="text" id="newCommentInput" placeholder="أضف تعليقاً..." 
                           class="flex-grow bg-transparent text-white text-sm px-2 focus:outline-none" 
                           dir="rtl" autocomplete="off">
                    <button id="postCommentBtn" class="p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-full transition w-9 h-9 flex items-center justify-center flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-arrow-up text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container (added for black glassy toasts) -->
    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<script>
const VERIFIED_IMG_URL = "https://res.cloudinary.com/duixjs8az/image/upload/v1768036959/post_media/1768036959482-badge.png";
// use provided default profile pic from server for users without profile picture
const DEFAULT_PROFILE_PIC_URL = 'https://res.cloudinary.com/duixjs8az/image/upload/v1765009560/post_media/1765009560909-default_profile.png';

let currentProfileId = null;
let currentUserId = null;
let activeWaveSurfer = null;
let audioWaveSurfers = {};
let activeVideo = null;
let currentPostIdForComments = null;
let statusPollInterval = null;
let PROFILE_VERIFIED = false; 
let currentPostIdToDelete = null;

/* --------- New variables for post options bottom sheet --------- */
let currentOptionsPostId = null;
let currentOptionsUserId = null;

/* ---------------- Toast helper (black glassy) ---------------- */
function showToast(message, opts = {}) {
    const { type = 'info', duration = 3500 } = opts;
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.setAttribute('role', 'status');
    toast.innerHTML = `
        <i class="${type === 'success' ? 'fas fa-check-circle' : (type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle')}"></i>
        <div class="msg">${escapeHtml(message)}</div>
        <button class="close-btn" aria-label="close">&times;</button>
    `;

    const closeBtn = toast.querySelector('.close-btn');
    const removeToast = () => {
        toast.style.transition = 'transform .18s cubic-bezier(.2,.8,.2,1), opacity .18s';
        toast.style.transform = 'translateY(-10px)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 200);
    };
    closeBtn.addEventListener('click', removeToast);

    container.appendChild(toast);

    // entrance animation
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-10px)';
    requestAnimationFrame(() => {
        toast.style.transition = 'transform .18s cubic-bezier(.2,.8,.2,1), opacity .18s';
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
    });

    const t = setTimeout(() => {
        removeToast();
    }, duration);

    // pause on hover
    toast.addEventListener('mouseenter', () => clearTimeout(t));
}

/* ---------------- UI helpers ---------------- */
function toggleProfileDropdown(event) {
    event.stopPropagation();
    const profileDropdown = document.getElementById('profileDropdown');
    profileDropdown.classList.toggle('hidden');
}
function closeProfileDropdownOnClickOutside(event) {
    const profileDropdown = document.getElementById('profileDropdown');
    const profileMenuButton = document.getElementById('profileMenuButton');
    if (!profileDropdown.contains(event.target) && !profileMenuButton.contains(event.target)) {
        profileDropdown.classList.add('hidden');
    }
}
document.addEventListener('click', closeProfileDropdownOnClickOutside);

function formatTimestamp(timestamp) {
    const date = new Date(Number(timestamp));
    const now = new Date();
    const diffInHours = (now - date) / (1000 * 60 * 60);
    if (diffInHours < 24) {
        return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    } else if (diffInHours < 7 * 24) {
        return date.toLocaleDateString('ar-EG', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
    } else {
        return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
    }
}

/* ---------------- Delete modal logic ---------------- */
const deleteModal = document.getElementById('deleteModal');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const deleteMessage = document.getElementById('deleteMessage');

function openDeleteModal(postId, event) {
    if(event) event.stopPropagation();
    currentPostIdToDelete = postId;
    deleteMessage.classList.add('hidden');
    deleteModal.classList.remove('hidden');
}

cancelDeleteBtn.addEventListener('click', () => {
    deleteModal.classList.add('hidden');
    currentPostIdToDelete = null;
});

confirmDeleteBtn.addEventListener('click', async () => {
    if (!currentPostIdToDelete) return;

    confirmDeleteBtn.disabled = true;
    confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الحذف';
    deleteMessage.classList.add('hidden');

    try {
        const response = await fetch(`/api/posts/${currentPostIdToDelete}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            const el = document.querySelector(`div[data-post-id="${currentPostIdToDelete}"]`);
            if (el) el.remove();
            deleteModal.classList.add('hidden');
            showToast('تم حذف المنشور.', { type: 'success' });
        } else {
            deleteMessage.textContent = result.error || 'فشل الحذف.';
            deleteMessage.classList.remove('hidden');
            showToast(deleteMessage.textContent, { type: 'error' });
        }
    } catch (error) {
        deleteMessage.textContent = 'حدث خطأ في الاتصال بالخادم.';
        deleteMessage.classList.remove('hidden');
        showToast(deleteMessage.textContent, { type: 'error' });
    } finally {
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.innerHTML = 'تأكيد الحذف';
        currentPostIdToDelete = null;
    }
});

/* ---------------- Media viewer ---------------- */
function openMediaViewer(url, type, event) {
    event.stopPropagation();
    const modal = document.getElementById('mediaViewerModal');
    const image = document.getElementById('mediaViewerImage');
    const video = document.getElementById('mediaViewerVideo');
    image.classList.add('hidden'); video.classList.add('hidden');
    if (type === 'image') { image.src = url; image.classList.remove('hidden'); }
    else if (type === 'video') { video.src = url; video.classList.remove('hidden'); video.play(); }
    modal.classList.remove('hidden');
}
function closeMediaViewer() {
    const modal = document.getElementById('mediaViewerModal');
    modal.classList.add('hidden');
    const video = document.getElementById('mediaViewerVideo');
    if (video) { video.pause(); video.currentTime = 0; video.src = ''; }
}

/* ---------------- WaveSurfer helpers (audio posts) ---------------- */

/* Add setWSColors and redrawWS (copied/adapted from main chat_list implementation)
   These helpers try multiple internal APIs for compatibility with different wavesurfer versions.
*/
function setWSColors(ws, waveColor, progressColor) {
    try {
        if (typeof ws.setWaveColor === 'function') ws.setWaveColor(waveColor);
        else if (ws.drawer && typeof ws.drawer.setWaveColor === 'function') ws.drawer.setWaveColor(waveColor);
    } catch (e) {}
    try {
        if (typeof ws.setProgressColor === 'function') ws.setProgressColor(progressColor);
        else if (ws.drawer && typeof ws.drawer.setProgressColor === 'function') ws.drawer.setProgressColor(progressColor);
    } catch (e) {}
}

function redrawWS(ws) {
    try {
        if (typeof ws.drawBuffer === 'function') {
            ws.drawBuffer();
            return;
        }
        if (ws.drawer && typeof ws.drawer.drawBuffer === 'function') {
            ws.drawer.drawBuffer();
            return;
        }
        // fallback: trigger a tiny seek to force repaint
        if (typeof ws.getDuration === 'function' && ws.getDuration() > 0) {
            const d = ws.getDuration();
            const current = ws.getCurrentTime ? ws.getCurrentTime() : 0;
            ws.seekTo(Math.min(1, (current + 0.0001) / (d || 1)));
            ws.seekTo(Math.min(1, current / (d || 1)));
        }
    } catch (e) {
        // ignore
    }
}

/* Unified initialize that stores instance in audioWaveSurfers and matches main feed behavior */
function initializePostWaveSurfer(postId, url) {
    const container = document.getElementById(`waveform-${postId}`);
    if (!container) return;

    // create wavesurfer
    const ws = WaveSurfer.create({
        container: container,
        waveColor: '#4A4A4A',      // idle: subtle unplayed
        progressColor: '#ffffff',  // progress white
        cursorColor: 'transparent',
        barWidth: 3,
        barRadius: 3,
        barGap: 1,
        height: 60,
        responsive: true,
        mediaControls: false,
    });

    // store immediately so toggleAudioPlay can reference it
    audioWaveSurfers[postId] = ws;

    try { ws.load(url); } catch(e){}

    const postCard = container.closest('.glass-post-card');
    const playButton = postCard ? postCard.querySelector('.audio-play-button') : null;

    if (playButton) {
        playButton.onclick = () => {
            // stop other active audio/waves
            if (activeWaveSurfer && activeWaveSurfer !== ws) {
                try { activeWaveSurfer.pause(); } catch(e){}
                const otherPostCard = activeWaveSurfer.container.closest('.glass-post-card');
                if (otherPostCard) {
                    const pb = otherPostCard.querySelector('.audio-play-button i');
                    if (pb) { pb.classList.remove('fa-pause'); pb.classList.add('fa-play'); }
                }
            }

            // stop active video if exists
            if (activeVideo) {
                const activePostId = activeVideo.id.split('-')[1];
                const controlIcon = document.getElementById(`control-icon-${activePostId}`);
                const playOverlay = document.getElementById(`play-overlay-${activePostId}`);
                activeVideo.pause();
                if (controlIcon) {
                    controlIcon.classList.remove('fa-pause');
                    controlIcon.classList.add('fa-play');
                }
                if (playOverlay) playOverlay.classList.remove('hidden');
                // detach listeners safely
                try {
                    activeVideo.removeEventListener('timeupdate', updateVideoProgress);
                    activeVideo.removeEventListener('loadedmetadata', updateVideoTimeDisplay);
                    activeVideo.removeEventListener('ended', handleVideoEnd);
                } catch(e){}
                activeVideo = null;
            }

            if (ws.isPlaying()) {
                ws.pause();
                playButton.querySelector('i').classList.remove('fa-pause');
                playButton.querySelector('i').classList.add('fa-play');
            } else {
                ws.play();
                playButton.querySelector('i').classList.remove('fa-play');
                playButton.querySelector('i').classList.add('fa-pause');
                activeWaveSurfer = ws;
            }
        };

        // events to manage colors & UI similar to main feed
        ws.on('play', () => {
            // set unplayed -> gray, progress -> white
            setWSColors(ws, '#6b7280', '#ffffff');
            redrawWS(ws);
        });

        ws.on('pause', () => {
            // revert unplayed to white and progress to white (idle appearance)
            setWSColors(ws, '#ffffff', '#ffffff');
            redrawWS(ws);
            const btn = playButton;
            if (btn) {
                btn.querySelector('i').classList.remove('fa-pause');
                btn.querySelector('i').classList.add('fa-play');
            }
            if (activeWaveSurfer === ws) activeWaveSurfer = null;
        });

        ws.on('finish', () => {
            setWSColors(ws, '#ffffff', '#ffffff');
            redrawWS(ws);
            const btn = playButton;
            if (btn) btn.querySelector('i').classList.remove('fa-pause'), btn.querySelector('i').classList.add('fa-play');
            try { ws.seekTo(0); } catch(e) {}
            activeWaveSurfer = null;
        });

        ws.on('audioprocess', (time) => {
            try {
                const duration = ws.getDuration ? ws.getDuration() : 0;
                if (duration > 0 && time / duration > 0.995) {
                    setWSColors(ws, '#ffffff', '#ffffff');
                    redrawWS(ws);
                }
            } catch(e){}
        });
    }
}

function toggleAudioPlay(postId) {
    const ws = audioWaveSurfers[postId];
    if (!ws) {
        const container = document.getElementById(`waveform-${postId}`);
        if (container && container.dataset && container.dataset.src) initializePostWaveSurfer(postId, container.dataset.src);
    }
    const wavesurfer = audioWaveSurfers[postId];
    if (!wavesurfer) return;
    if (wavesurfer.isPlaying()) wavesurfer.pause();
    else wavesurfer.play();
}

/* ----------------- Video controls (same behavior/implementation as chat_list) ----------------- */

function toggleVideoPlay(postId, event) {
    if (event && event.stopPropagation) event.stopPropagation();
    const video = document.getElementById(`video-${postId}`);
    const playOverlay = document.getElementById(`play-overlay-${postId}`);

    if (!video) return;

    // Pause any other active video
    if (activeVideo && activeVideo !== video) {
        const activePostId = activeVideo.id.split('-')[1];
        const activePlayOverlay = document.getElementById(`play-overlay-${activePostId}`);
        try { activeVideo.pause(); } catch(e){}
        if (activePlayOverlay) activePlayOverlay.classList.remove('hidden');
        // remove event listeners for previous active video
        try {
            activeVideo.removeEventListener('timeupdate', updateVideoProgress);
            activeVideo.removeEventListener('loadedmetadata', updateVideoTimeDisplay);
            activeVideo.removeEventListener('ended', handleVideoEnd);
        } catch(e){}
        activeVideo = null;
    }

    // Pause any playing wave audio
    if (activeWaveSurfer) {
        try { activeWaveSurfer.pause(); } catch(e){}
        const otherPostCard = activeWaveSurfer.container && activeWaveSurfer.container.closest ? activeWaveSurfer.container.closest('.glass-post-card') : null;
        if (otherPostCard) {
            const apb = otherPostCard.querySelector('.audio-play-button i');
            if (apb) { apb.classList.remove('fa-pause'); apb.classList.add('fa-play'); }
        }
        activeWaveSurfer = null;
    }
    
    if (video.paused) {
        video.play().then(() => {
            if (playOverlay) playOverlay.classList.add('hidden'); 
            activeVideo = video;
            video.addEventListener('timeupdate', updateVideoProgress);
            video.addEventListener('loadedmetadata', updateVideoTimeDisplay);
            video.addEventListener('ended', handleVideoEnd);
        }).catch((err) => {
            console.warn('Video play failed', err);
        });
    } else {
        video.pause();
        if (playOverlay) playOverlay.classList.remove('hidden'); 
        // remove event listeners when paused/stopped
        video.removeEventListener('timeupdate', updateVideoProgress);
        video.removeEventListener('loadedmetadata', updateVideoTimeDisplay);
        video.removeEventListener('ended', handleVideoEnd);
        activeVideo = null;
    }
}

function updateVideoProgress(event) {
    const video = event.target;
    const postId = video.id.split('-')[1];
    const progressBar = document.getElementById(`progress-bar-${postId}`);
    const timeDisplay = document.getElementById(`time-display-${postId}`);

    if (!video.duration || !progressBar || !timeDisplay) return;

    const percent = (video.currentTime / video.duration) * 100;
    progressBar.style.width = `${percent}%`;
    timeDisplay.textContent = `${formatVideoTime(video.currentTime)} / ${formatVideoTime(video.duration)}`;
}

function updateVideoTimeDisplay(event) {
    const video = event.target;
    const postId = video.id.split('-')[1];
    const timeDisplay = document.getElementById(`time-display-${postId}`);

    if (timeDisplay && video.duration) {
        timeDisplay.textContent = `0:00 / ${formatVideoTime(video.duration)}`;
    }
}

function handleVideoEnd(event) {
    const video = event.target;
    const postId = video.id.split('-')[1];
    const playOverlay = document.getElementById(`play-overlay-${postId}`);
    
    video.currentTime = 0;
    if (playOverlay) playOverlay.classList.remove('hidden'); 
    activeVideo = null;
    
    video.removeEventListener('timeupdate', updateVideoProgress);
    video.removeEventListener('loadedmetadata', updateVideoTimeDisplay);
    video.removeEventListener('ended', handleVideoEnd);
}

function formatVideoTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function seekVideo(postId, event) {
    event.stopPropagation();
    const bar = event.currentTarget || event.target;
    const rect = bar.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const percent = x / rect.width;
    const video = document.getElementById(`video-${postId}`);
    if (video && video.duration) {
        video.currentTime = video.duration * percent;
    }
}

function toggleFullscreen(postId, ev) {
    if (ev && ev.stopPropagation) ev.stopPropagation();
    const video = document.getElementById(`video-${postId}`);
    if (!video) return;
    // Prefer element fullscreen on container for chrome mobile compatibility
    const container = video.closest('.video-large') || video;
    if (container.requestFullscreen) {
        container.requestFullscreen().catch(()=>{});
    } else if (container.webkitRequestFullscreen) {
        container.webkitRequestFullscreen().catch(()=>{});
    } else if (video.requestFullscreen) {
        video.requestFullscreen().catch(()=>{});
    }
}

/* ----------------- Posts rendering (modified to use .video-large like chat_list) ----------------- */
function createPostCard(post) {
    let mediaContent = '';
    if (post.media) {
        if (post.media.type === 'image') {
            mediaContent = `
                <div class="mt-3 cursor-pointer" onclick="openMediaViewer('${post.media.url}', 'image', event)">
                    <img src="${post.media.url}" alt="صورة المنشور" class="w-full max-h-96 object-cover rounded-lg">
                </div>`;
        } else if (post.media.type === 'video') {
            const poster = post.media.poster || post.media.thumbnail || 'https://via.placeholder.com/1200x675?text=Video';
            mediaContent = `
                <div class="mt-3 relative w-full video-large rounded-lg overflow-hidden bg-black group">
                    <video id="video-${post.postId}" src="${post.media.url}" class="w-full h-full object-cover" poster="${poster}" preload="metadata" onclick="toggleVideoPlay('${post.postId}', event)"></video>
                    <div id="play-overlay-${post.postId}" class="video-play-overlay" onclick="toggleVideoPlay('${post.postId}', event)">
                        <i class="fas fa-play"></i>
                    </div>
                    <button class="video-fs-btn" onclick="toggleFullscreen('${post.postId}', event)" title="تكبير">
                      <i class="fas fa-expand"></i>
                    </button>
                </div>`;
        } else if (post.media.type === 'audio') {
            mediaContent = `
                <div class="mt-3">
                    <div class="audio-play-wrapper">
                        <button id="audio-btn-${post.postId}" class="audio-play-button" onclick="toggleAudioPlay('${post.postId}')">
                            <i class="fas fa-play"></i>
                        </button>
                        <div id="waveform-${post.postId}" class="waveform-post flex-grow" data-src="${post.media.url}"></div>
                    </div>
                </div>`;
        }
    }

    const likeIconClass = post.is_liked ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-400';
    const likeButtonClass = post.is_liked ? 'text-red-500' : 'text-gray-400';
    const isOnline = post.user && post.user.is_online;
    const dotDisplay = isOnline ? 'block' : 'none';
    const verifiedBadgeHtml = post.user && post.user.is_verified ? `<img src="${VERIFIED_IMG_URL}" class="verified-badge-img" alt="موثق" title="موثق">` : '';
    const profilePic = post.user && post.user.profile_picture_url ? post.user.profile_picture_url : DEFAULT_PROFILE_PIC_URL;

    return `
        <div class="glass-post-card p-4 rounded-xl shadow-lg" data-post-id="${post.postId}">
            <div class="flex items-start justify-between mb-3">
                <div class="flex items-center">
                    <a href="/profile?userId=${post.userId}" class="avatar-wrapper ml-3" data-user-id="${post.userId}">
                        <img src="${escapeHtml(profilePic)}" alt="${escapeHtml(post.user.username)}" class="w-10 h-10 rounded-full object-cover ml-3 border border-gray-600">
                        <span class="status-indicator small" style="display: ${dotDisplay};" title="متصل الآن"></span>
                    </a>
                    <div>
                        <a href="/profile?userId=${post.userId}" class="text-white font-semibold hover:text-blue-400">@${post.user.username} ${verifiedBadgeHtml}</a>
                        <p class="text-gray-400 text-xs">${formatTimestamp(post.timestamp)}</p>
                    </div>
                </div>
                ${/* always render menu button but bottom sheet will decide options */ ''}
                <button class="text-gray-400 hover:text-white transition duration-300 post-menu-button" onclick="togglePostMenu('${post.postId}', '${post.userId}', event, this)"><i class="fas fa-ellipsis-v"></i></button>
            </div>
            <p class="text-gray-200 whitespace-pre-wrap">${post.content}</p>
            ${mediaContent}
            <div class="flex justify-between items-center text-gray-400 text-sm mt-3 pb-2 border-b border-gray-700">
                <span><i class="fas fa-heart ml-1"></i> ${post.likes} إعجاب</span>
                <span class="cursor-pointer hover:text-blue-400 comment-count-display" onclick="handleComment('${post.postId}')"><i class="far fa-comment-dots ml-1"></i> ${post.commentsCount || 0} تعليق</span>
            </div>
            <div class="flex justify-around border-t border-gray-700 mt-3 pt-3">
                <button class="flex items-center ${likeButtonClass} hover:text-red-500 transition duration-300 w-full justify-center post-like-button" data-is-liked="${post.is_liked}" onclick="handleLike('${post.postId}', this)">
                    <i class="${likeIconClass} ml-2 like-icon"></i> إعجاب
                </button>
                <button class="flex items-center text-gray-400 hover:text-blue-500 transition duration-300 w-full justify-center" onclick="handleComment('${post.postId}')">
                    <i class="fas fa-comment-dots ml-2"></i> تعليق
                </button>
            </div>
        </div>
    `;
}

/* ----------------- Comment UI (like & reply) ----------------- */

// (the comment-related functions remain unchanged — omitted here for brevity in this comment section)
// ... (functions createCommentHtml, toggleCommentLike, openReplyBox, postReply, fetchAndShowAllReplies)
// They are defined below (kept the same as earlier in the file) — no changes required.

function createCommentHtml(comment, postIdForSafety = '') {
    const postId = comment.postId || postIdForSafety || '';
    const commentDate = new Date(comment.timestamp).toLocaleString('ar-EG', {
        month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric'
    });
    const verifiedHtml = '';
    const likeBtnClass = comment.is_liked ? 'text-red-400' : 'text-gray-400';
    const likeIconClass = comment.is_liked ? 'fas' : 'far';

    const repliesPreviewHtml = (comment.recentReplies && comment.recentReplies.length > 0) ? comment.recentReplies.map(r => `
        <div class="reply-item flex items-start gap-2">
            <img src="${escapeHtml(r.profile_picture_url || DEFAULT_PROFILE_PIC_URL)}" class="small-avatar flex-shrink-0" alt="${escapeHtml(r.username)}">
            <div class="flex-1">
                <div class="text-xs text-gray-300 font-bold">${escapeHtml(r.username)}</div>
                <div class="text-sm text-gray-200">${escapeHtml(r.content)}</div>
            </div>
        </div>
    `).join('') : '';

    return `
        <div class="comment-item" id="comment-${comment.commentId}">
            <div class="flex items-start gap-3">
                <img src="${escapeHtml((comment.user && comment.user.profile_picture_url) ? comment.user.profile_picture_url : DEFAULT_PROFILE_PIC_URL)}" class="w-8 h-8 rounded-full flex-shrink-0" alt="${escapeHtml(comment.user.username)}">
                <div class="flex-1">
                    <div class="flex items-center justify-between gap-2">
                        <div>
                            <div class="text-sm font-bold text-white">${escapeHtml(comment.user.username)} ${verifiedHtml}</div>
                            <div class="text-xs text-gray-500">${commentDate}</div>
                        </div>
                        <div class="flex items-center gap-2 comment-actions">
                            <button class="flex items-center gap-1 px-2 py-1 rounded-full ${likeBtnClass}" onclick="toggleCommentLike('${postId}', '${comment.commentId}', this)">
                                <i class="${likeIconClass} fa-heart"></i>
                                <span class="text-xs like-count" id="comment-like-count-${comment.commentId}">${comment.likes || 0}</span>
                            </button>
                            <button class="flex items-center gap-1 px-2 py-1 rounded-full text-gray-300" onclick="openReplyBox('${comment.commentId}')">
                                <i class="fas fa-reply"></i>
                                <span class="text-xs">رد</span>
                            </button>
                            <button class="flex items-center gap-1 px-2 py-1 rounded-full text-gray-400 hidden" onclick="fetchAndShowAllReplies('${postId}', '${comment.commentId}', this)">
                                <i class="fas fa-angle-down"></i>
                                <span class="text-xs">عرض الردود</span>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 text-sm text-gray-200">${escapeHtml(comment.content)}</div>

                    <div id="replies-container-${comment.commentId}" class="mt-3 space-y-2">
                        ${repliesPreviewHtml}
                    </div>

                    <div id="reply-box-${comment.commentId}" class="mt-2 hidden">
                        <div class="flex items-center gap-2 bg-[#111] p-2 rounded-xl">
                            <img src="${document.getElementById('userProfilePic').src}" class="w-7 h-7 rounded-full" alt="me">
                            <input id="reply-input-${comment.commentId}" class="flex-1 bg-transparent text-sm text-white outline-none" placeholder="أكتب رد..." />
                            <button class="px-3 py-1 bg-blue-600 rounded-md" onclick="postReply('${postId}', '${comment.commentId}')"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    `;
}

async function toggleCommentLike(postId, commentId, btnEl) {
    btnEl.disabled = true;
    try {
        const res = await fetch(`/api/posts/${encodeURIComponent(postId)}/comments/${encodeURIComponent(commentId)}/like`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await res.json();
        if (res.ok && data.ok) {
            const countEl = document.getElementById(`comment-like-count-${commentId}`);
            if (countEl) countEl.textContent = data.likes;
            if (data.is_liked) {
                btnEl.classList.remove('text-gray-400');
                btnEl.classList.add('text-red-400');
                const i = btnEl.querySelector('i');
                if (i) { i.classList.remove('far'); i.classList.add('fas'); }
            } else {
                btnEl.classList.remove('text-red-400');
                btnEl.classList.add('text-gray-400');
                const i = btnEl.querySelector('i');
                if (i) { i.classList.remove('fas'); i.classList.add('far'); }
            }
        } else {
            console.warn('Like comment failed', data);
        }
    } catch (e) {
        console.error(e);
    } finally {
        btnEl.disabled = false;
    }
}

function openReplyBox(commentId) {
    const box = document.getElementById(`reply-box-${commentId}`);
    if (!box) return;
    box.classList.toggle('hidden');
    const input = document.getElementById(`reply-input-${commentId}`);
    if (input && !box.classList.contains('hidden')) input.focus();
}

async function postReply(postId, commentId) {
    const input = document.getElementById(`reply-input-${commentId}`);
    if (!input) return;
    const content = input.value.trim();
    if (!content) return;
    input.disabled = true;
    try {
        const res = await fetch(`/api/posts/${encodeURIComponent(postId)}/comments/${encodeURIComponent(commentId)}/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ content })
        });
        const data = await res.json();
        if (res.ok && data.ok) {
            // refresh comments list to show the new reply
            await fetchAndDisplayComments(postId);
        } else {
            showToast(data.error || 'فشل في إرسال الرد', { type: 'error' });
            input.disabled = false;
        }
    } catch (e) {
        console.error(e);
        showToast('فشل في الاتصال', { type: 'error' });
        input.disabled = false;
    }
}

async function fetchAndShowAllReplies(postId, commentId, triggerBtn) {
    try {
        triggerBtn.disabled = true;
        const res = await fetch(`/api/posts/${encodeURIComponent(postId)}/comments/${encodeURIComponent(commentId)}/replies`, { credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok && data.ok) {
            const container = document.getElementById(`replies-container-${commentId}`);
            if (container) {
                container.innerHTML = data.replies.map(r => `
                    <div class="reply-item flex items-start gap-2">
                        <img src="${escapeHtml(r.profile_picture_url || DEFAULT_PROFILE_PIC_URL)}" class="small-avatar flex-shrink-0" alt="${escapeHtml(r.username)}">
                        <div class="flex-1">
                            <div class="text-xs text-gray-300 font-bold">${escapeHtml(r.username)}</div>
                            <div class="text-sm text-gray-200">${escapeHtml(r.content)}</div>
                        </div>
                    </div>
                `).join('');
            }
        }
    } catch (e) {
        console.error(e);
    } finally {
        triggerBtn.disabled = false;
    }
}

/* ----------------- Fetch & display comments (profile) ----------------- */
async function fetchAndDisplayComments(postId) {
    const commentsListEl = document.getElementById('commentsList');
    const badgeEl = document.getElementById('commentCountBadge');
    
    commentsListEl.innerHTML = '<div class="flex justify-center py-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i></div>';
    
    try {
        const response = await fetch(`/api/posts/${encodeURIComponent(postId)}/comments`, { credentials: 'same-origin' });
        const result = await response.json();

        if (response.ok && result.ok) {
            commentsListEl.innerHTML = '';
            const comments = result.comments || [];
            
            if(badgeEl) badgeEl.innerText = comments.length;

            updatePostCommentCount(postId, comments.length);

            if (comments.length === 0) {
                commentsListEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-500 opacity-70">
                        <i class="far fa-comments text-4xl mb-3"></i>
                        <p class="text-sm">لا توجد تعليقات بعد.</p>
                        <p class="text-xs">كن أول من يعلق!</p>
                    </div>`;
            } else {
                const htmlBuffer = comments.map(c => createCommentHtml(c, postId)).join('');
                commentsListEl.innerHTML = htmlBuffer;

                // After rendering, ensure "عرض كل الردود" buttons are visible when repliesCount > recentReplies.length
                comments.forEach(c => {
                    try {
                        const btn = document.querySelector(`#comment-${c.commentId} .comment-actions button:nth-child(3)`);
                        if (btn) {
                            if ((c.repliesCount || 0) > (c.recentReplies ? c.recentReplies.length : 0)) btn.classList.remove('hidden');
                            else btn.classList.add('hidden');
                        }
                    } catch(e){}
                });

                setTimeout(() => {
                    if(commentsListEl.lastElementChild) {
                        commentsListEl.scrollTop = commentsListEl.scrollHeight;
                    }
                }, 100);

                // background check for verified badges
                updateCommentsVerification(comments);
            }
        } else {
            commentsListEl.innerHTML = '<div class="text-center text-red-400 py-4 text-sm">فشل تحميل التعليقات.</div>';
        }
    } catch (error) {
        console.error(error);
        commentsListEl.innerHTML = '<div class="text-center text-red-400 py-4 text-sm">خطأ في الاتصال.</div>';
    }
}

/* ---------------- Update verification badges for commenters ---------------- */
async function updateCommentsVerification(comments) {
     const userIds = [...new Set(comments.map(c => (c.user && c.user.userId) ? c.user.userId : ''))].filter(Boolean);
     if(userIds.length === 0) return;

     try {
        const promises = userIds.map(uid => fetch(`/api/profile?userId=${uid}`).then(r => r.ok ? r.json() : null).catch(()=>null));
        const profiles = await Promise.all(promises);
        
        profiles.forEach(p => {
            if(p && p.id && p.is_verified) {
                // find comment blocks for this user and insert badge if missing
                const commentEls = document.querySelectorAll(`.comment-item img[src][alt]`);
                // We'll search by username match as fallback
                commentEls.forEach(img => {
                    const parent = img.closest('.comment-item');
                    if (!parent) return;
                    const nameEl = parent.querySelector('.text-sm.font-bold');
                    if (!nameEl) return;
                    if (nameEl.textContent.trim().startsWith(p.username)) {
                        // append badge if not exists
                        if (!nameEl.querySelector('img.verified-badge-img')) {
                            nameEl.innerHTML = `${escapeHtml(p.username)} <img src="${VERIFIED_IMG_URL}" class="verified-badge-img" alt="موثق">`;
                        }
                    }
                });
            }
        });
     } catch(e) { console.warn('Background verification check failed', e); }
}

/* ----------------- Posts list and initial load ----------------- */
function updatePostCommentCount(postId, count) {
    const postCard = document.querySelector(`div[data-post-id="${postId}"]`);
    if (postCard) {
        const commentSpan = postCard.querySelector('.comment-count-display');
        if (commentSpan) {
            commentSpan.innerHTML = `<i class="far fa-comment-dots ml-1"></i> ${count} تعليق`;
        }
    }
    const badgeEl = document.getElementById('commentCountBadge');
    if (badgeEl && currentPostIdForComments === postId) {
        badgeEl.innerText = count;
    }
}

async function fetchAndDisplayUserPosts(userId) {
    const userPostsFeed = document.getElementById('userPostsFeed');
    userPostsFeed.innerHTML = '<div class="text-center text-gray-500 p-8"><i class="fas fa-spinner fa-spin ml-2"></i> جاري تحميل المنشورات...</div>';

    try {
        const response = await fetch(`/api/posts/user/${encodeURIComponent(userId)}`, { credentials: 'same-origin' });
        const result = await response.json();

        userPostsFeed.innerHTML = '';

        if (response.ok && result.ok) {
            if (result.posts.length === 0) {
                userPostsFeed.innerHTML = '<div class="text-center text-gray-500 p-8">لا توجد منشورات لعرضها بعد.</div>';
            } else {
                const audioPostsToInit = [];
                result.posts.forEach(post => {
                    post.user = post.user || {};
                    if (typeof post.user.is_verified === 'undefined') post.user.is_verified = !!PROFILE_VERIFIED;

                    userPostsFeed.innerHTML += createPostCard(post);
                    if (post.media && post.media.type === 'audio') audioPostsToInit.push({ postId: post.postId, url: post.media.url });
                });
                setTimeout(() => {
                    audioPostsToInit.forEach(ap => initializePostWaveSurfer(ap.postId, ap.url));
                }, 100);

                startStatusPolling();
            }
        } else {
            userPostsFeed.innerHTML = '<div class="text-center text-red-500 p-8">فشل في جلب المنشورات.</div>';
        }
    } catch (error) {
        console.error('Error fetching user posts:', error);
        userPostsFeed.innerHTML = '<div class="text-center text-red-500 p-8">حدث خطأ في الاتصال بالخادم.</div>';
    }
}

/* ----------------- Like post (already present) ----------------- */
async function handleLike(postId, buttonElement) {
    const likeIcon = buttonElement.querySelector('.like-icon');
    buttonElement.disabled = true;
    try {
        const res = await fetch(`/api/posts/${encodeURIComponent(postId)}/like`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok && data.ok) {
            if (data.action === 'liked') {
                likeIcon.classList.remove('far', 'text-gray-400');
                likeIcon.classList.add('fas', 'text-red-500');
                buttonElement.classList.remove('text-gray-400');
                buttonElement.classList.add('text-red-500');
                buttonElement.setAttribute('data-is-liked', 'true');
            } else {
                likeIcon.classList.remove('fas', 'text-red-500');
                likeIcon.classList.add('far', 'text-gray-400');
                buttonElement.classList.remove('text-red-500');
                buttonElement.classList.add('text-gray-400');
                buttonElement.setAttribute('data-is-liked', 'false');
            }
            if (data.newLikes !== undefined) {
                const postCard = document.querySelector(`div[data-post-id="${postId}"]`);
                if (postCard) {
                    const likesElem = postCard.querySelector('.flex.justify-between span:first-child');
                    if (likesElem) likesElem.innerHTML = `<i class="fas fa-heart ml-1"></i> ${data.newLikes} إعجاب`;
                }
            }
        }
    } catch (e) {
        console.error(e);
    } finally {
        buttonElement.disabled = false;
    }
}

/* ----------------- Comment modal open/close (profile) ----------------- */

function handleComment(postId) { 
    currentPostIdForComments = postId;
    
    const myPic = (document.getElementById('userProfilePic').src || DEFAULT_PROFILE_PIC_URL);
    const inputAvatar = document.getElementById('myCurrentAvatar');
    if(inputAvatar) inputAvatar.src = myPic;

    const modal = document.getElementById('commentModal');
    const content = document.getElementById('commentModalContent');
    
    modal.classList.remove('hidden');
    
    setTimeout(() => {
        content.classList.add('open');
    }, 10);

    fetchAndDisplayComments(postId);
}

function closeCommentModal() {
    const modal = document.getElementById('commentModal');
    const content = document.getElementById('commentModalContent');
    
    content.classList.remove('open');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        currentPostIdForComments = null;
        if(document.getElementById('newCommentInput')) document.getElementById('newCommentInput').value = '';
        if(document.getElementById('commentsList')) document.getElementById('commentsList').innerHTML = '';
        if(document.getElementById('commentCountBadge')) document.getElementById('commentCountBadge').innerText = '0';
    }, 300);
}

async function postComment() {
    const input = document.getElementById('newCommentInput');
    const btn = document.getElementById('postCommentBtn');
    const errorEl = document.getElementById('commentError');
    
    const content = input.value.trim();
    if (!content || !currentPostIdForComments) return;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    errorEl.classList.add('hidden');

    try {
        const response = await fetch(`/api/posts/${encodeURIComponent(currentPostIdForComments)}/comment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ content: content })
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            // After successful post, re-fetch the entire comments list to avoid shape/count divergence
            await fetchAndDisplayComments(currentPostIdForComments);

            // If server returned a newComments count, ensure post card is updated (fallback kept)
            if (typeof result.newComments !== 'undefined' && result.newComments !== null) {
                updatePostCommentCount(currentPostIdForComments, Number(result.newComments));
            }

            input.value = '';
            input.focus();
        } else {
            errorEl.textContent = result.error || 'فشل الإرسال';
            errorEl.classList.remove('hidden');
            showToast(errorEl.textContent, { type: 'error' });
        }
    } catch (error) {
        errorEl.textContent = 'حدث خطأ';
        errorEl.classList.remove('hidden');
        showToast(errorEl.textContent, { type: 'error' });
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-arrow-up text-sm"></i>';
    }
}

/* ----------------- Post options bottom sheet functions ----------------- */

function openPostOptionsModal(postId, userId) {
    currentOptionsPostId = postId;
    currentOptionsUserId = userId;
    const postOptionsMessage = document.getElementById('postOptionsMessage');
    const postOptionsDeleteBtn = document.getElementById('postOptionsDeleteBtn');
    const postOptionsAddFriendBtn = document.getElementById('postOptionsAddFriendBtn');

    if (postOptionsMessage) postOptionsMessage.classList.add('hidden');

    // if owner -> show delete, hide add-friend
    if (currentUserId && userId === currentUserId) {
        if (postOptionsDeleteBtn) postOptionsDeleteBtn.style.display = 'flex';
        if (postOptionsAddFriendBtn) postOptionsAddFriendBtn.style.display = 'none';
    } else {
        if (postOptionsDeleteBtn) postOptionsDeleteBtn.style.display = 'none';
        if (postOptionsAddFriendBtn) postOptionsAddFriendBtn.style.display = 'flex';
    }

    const modal = document.getElementById('postOptionsModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
}

function closePostOptionsModal() {
    const modal = document.getElementById('postOptionsModal');
    const postOptionsMessage = document.getElementById('postOptionsMessage');
    if (modal) modal.classList.add('hidden');
    if (postOptionsMessage) postOptionsMessage.classList.add('hidden');
    document.body.style.overflow = 'auto';
    currentOptionsPostId = null;
    currentOptionsUserId = null;
}

// Called when user taps delete inside bottom sheet
function confirmDeleteFromOptions(e) {
    e.stopPropagation();
    if (!currentOptionsPostId) return;
    // reuse existing delete modal logic
    openDeleteModal(currentOptionsPostId, e);
    closePostOptionsModal();
}

// Add friend from bottom sheet
async function addFriendFromOptions(e) {
    e.stopPropagation();
    if (!currentOptionsUserId) return;
    const postOptionsAddFriendBtn = document.getElementById('postOptionsAddFriendBtn');
    const postOptionsMessage = document.getElementById('postOptionsMessage');
    if (postOptionsAddFriendBtn) postOptionsAddFriendBtn.disabled = true;
    if (postOptionsMessage) postOptionsMessage.classList.add('hidden');

    try {
        const res = await fetch('/api/friends/request', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to_id: currentOptionsUserId })
        });
        const data = await res.json();
        if (res.ok && data.ok) {
            if (postOptionsMessage) {
                postOptionsMessage.textContent = 'تم إرسال طلب الصداقة.';
                postOptionsMessage.classList.remove('hidden');
            }
            // update friend requests badge by re-fetching count (best-effort)
            fetch('/api/friends/requests_count', { credentials: 'same-origin' })
              .then(r => r.ok ? r.json() : null)
              .then(d => {
                if (d && d.ok) {
                  const fr = document.getElementById('friendReqBadge');
                  if (fr && d.count > 0) { fr.style.display = 'inline-flex'; fr.textContent = d.count > 99 ? '99+' : String(d.count); }
                }
              }).catch(()=>{});
            // Optionally hide add button or give visual feedback
            if (postOptionsAddFriendBtn) postOptionsAddFriendBtn.style.display = 'none';
        } else {
            const err = data && data.error ? data.error : 'فشل إرسال الطلب';
            if (postOptionsMessage) {
                postOptionsMessage.textContent = err;
                postOptionsMessage.classList.remove('hidden');
            } else {
                showToast(err, { type: 'error' });
            }
        }
    } catch (err) {
        console.error(err);
        if (postOptionsMessage) {
            postOptionsMessage.textContent = 'خطأ في الاتصال.';
            postOptionsMessage.classList.remove('hidden');
        } else {
            showToast('خطأ في الاتصال.', { type: 'error' });
        }
    } finally {
        if (postOptionsAddFriendBtn) postOptionsAddFriendBtn.disabled = false;
    }
}

/* ----------------- Toggle post menu (updated to use bottom sheet on small screens) ----------------- */
function togglePostMenu(postId, userId, event, menuButton) {
    event.stopPropagation();
    // On small screens prefer bottom sheet with same options
    if (window.innerWidth < 640) {
        openPostOptionsModal(postId, userId);
        return;
    }

    const postMenu = document.getElementById('postMenu');
    if (!postMenu) return;
    if (!postMenu.classList.contains('hidden') && postMenu.dataset.postId === postId) {
        postMenu.classList.add('hidden');
        return;
    }
    const rect = menuButton.getBoundingClientRect();
    if (window.innerWidth < 640) {
        postMenu.style.top = `${window.innerHeight/2 - 80}px`;
        postMenu.style.left = `${window.innerWidth/2 - 80}px`;
    } else {
        postMenu.style.top = `${rect.bottom + 5}px`;
        postMenu.style.left = `${rect.left}px`;
    }
    postMenu.dataset.postId = postId;
    if (userId === currentUserId) {
        const deleteOptionBtn = document.getElementById('deleteOptionBtn');
        deleteOptionBtn.style.display = 'flex';
        deleteOptionBtn.onclick = (e) => openDeleteModal(postId, e);
    } else {
        document.getElementById('deleteOptionBtn').style.display = 'none';
    }
}

document.addEventListener('click', (event) => {
    const postMenu = document.getElementById('postMenu');
    if (postMenu && !postMenu.contains(event.target) && !event.target.closest('.post-menu-button')) {
        postMenu.classList.add('hidden');
        deleteModal.classList.add('hidden'); 
    }
});

/* ----------------- Fetch & profile logic (unchanged with fixes) ----------------- */

async function fetchCurrentUser() {
    try {
        const resp = await fetch('/api/profile', { credentials: 'same-origin' });
        if (!resp.ok) return;
        const data = await resp.json();
        if (data && data.id) {
            currentUserId = data.id;
            const smallPic = document.getElementById('userProfilePic');
            if (smallPic) smallPic.src = data.profile_picture_url || DEFAULT_PROFILE_PIC_URL;
        }
    } catch (e) {
        console.error('fetchCurrentUser failed', e);
    }
}

async function fetchAndDisplayProfile() {
    await fetchCurrentUser();

    const urlParams = new URLSearchParams(window.location.search);
    const requestedUserId = urlParams.get('userId');
    currentProfileId = requestedUserId || currentUserId;
    if (!currentProfileId) {
        document.getElementById('userPostsFeed').innerHTML = '<div class="text-center text-red-500 p-8">خطأ: لا يمكن تحديد الملف الشخصي.</div>';
        return;
    }

    try {
        const response = await fetch(`/api/profile?userId=${encodeURIComponent(currentProfileId)}`, { credentials: 'same-origin' });
        const data = await response.json();

        if (response.ok && data.ok) {
            PROFILE_VERIFIED = !!data.is_verified;

            const profileAvatarWrap = document.getElementById('profileAvatarWrap');
            profileAvatarWrap.dataset.userId = data.id;

            // ensure we use server default when no profile picture
            document.getElementById('profileImage').src = data.profile_picture_url || DEFAULT_PROFILE_PIC_URL;
            if (data.cover_photo_url) document.getElementById('coverPhotoContainer').style.backgroundImage = `url('${data.cover_photo_url}')`;

            const profileUsernameEl = document.getElementById('profileUsername');
            profileUsernameEl.innerHTML = `@${data.username}` + (data.is_verified ? ` <img src="${VERIFIED_IMG_URL}" class="verified-badge-img list" alt="موثق" title="موثق">` : '');

            document.getElementById('profileFullName').textContent = data.full_name || 'لا يوجد اسم كامل';
            document.getElementById('profileBio').textContent = data.bio || '';
            document.getElementById('pageTitle').textContent = `Aite - @${data.username}`;

            setUserOnlineUI(data.id, !!data.is_online, data.last_seen);

            const friendActionContainer = document.getElementById('friendActionContainer');
            friendActionContainer.innerHTML = '';
            const editProfileButton = document.getElementById('editProfileButton');
            const chatButton = document.getElementById('chatButton');

            // Explicitly hide chat button for owner's own profile
            if (chatButton) {
                chatButton.style.display = 'none';
                chatButton.href = '#';
            }

            if (currentUserId && data.id === currentUserId) {
                editProfileButton.classList.remove('hidden');
                // keep chat button hidden when viewing own profile
                if (chatButton) chatButton.style.display = 'none';
            } else {
                editProfileButton.classList.add('hidden');

                // Update chatButton appearance to match all_users style when visible
                if (data.is_friend) {
                    if (chatButton) {
                        chatButton.href = `/chat?contactId=${currentProfileId}`;
                        chatButton.classList.remove('hidden');
                        chatButton.style.display = 'inline-flex';
                    }
                } else {
                    if (chatButton) {
                        chatButton.classList.add('hidden');
                        chatButton.style.display = 'none';
                    }
                }

                if (data.request_received) {
                    friendActionContainer.innerHTML = `
                      <button id="acceptFriendBtn" class="btn-accept"><i class="fas fa-user-check ml-2"></i>قبول</button>
                      <button id="rejectFriendBtn" class="btn-reject"><i class="fas fa-times ml-2"></i>رفض</button>
                    `;
                    document.getElementById('acceptFriendBtn').addEventListener('click', async () => {
                        try {
                            const r = await fetch('/api/friends/accept', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from_id: currentProfileId })});
                            const j = await r.json();
                            if (r.ok && j.ok) { showToast('تمت الموافقة — أصبح هذا المستخدم صديقك.', { type: 'success' }); fetchAndDisplayProfile(); }
                            else { showToast('فشل في قبول الطلب.', { type: 'error' }); }
                        } catch (e) { showToast('خطأ في الشبكة', { type: 'error' }); }
                    });
                    document.getElementById('rejectFriendBtn').addEventListener('click', async () => {
                        try {
                            const r = await fetch('/api/friends/reject', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from_id: currentProfileId })});
                            const j = await r.json();
                            if (r.ok && j.ok) { showToast('تم رفض الطلب.', { type: 'success' }); fetchAndDisplayProfile(); }
                            else { showToast('فشل في رفض الطلب.', { type: 'error' }); }
                        } catch (e) { showToast('خطأ في الشبكة', { type: 'error' }); }
                    });
                } else if (data.request_sent) {
                    friendActionContainer.innerHTML = `<button id="cancelFriendBtn" class="action-btn"><i class="fas fa-clock ml-2"></i>طلب مرسل</button>`;
                    document.getElementById('cancelFriendBtn').addEventListener('click', async (ev) => {
                        const btn = ev.currentTarget;
                        try {
                            btn.disabled = true;
                            btn.textContent = 'جاري الإلغاء...';
                            const r = await fetch('/api/friends/cancel', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to_id: currentProfileId })});
                            const j = await r.json();
                            if (r.ok && j.ok) { showToast('تم إلغاء الطلب.', { type: 'success' }); fetchAndDisplayProfile(); } else { showToast('فشل في إلغاء الطلب.', { type: 'error' }); fetchAndDisplayProfile(); }
                        } catch (e) { showToast('خطأ في الشبكة', { type: 'error' }); fetchAndDisplayProfile(); }
                    });
                } else if (!data.is_friend) {
                    friendActionContainer.innerHTML = `<button id="addFriendBtn" class="action-btn"><i class="fas fa-user-plus ml-2"></i>إضافة صديق</button>`;
                    document.getElementById('addFriendBtn').addEventListener('click', async (ev) => {
                        const btn = ev.currentTarget;
                        try {
                            btn.disabled = true;
                            btn.textContent = 'جاري الإرسال...';
                            const r = await fetch('/api/friends/request', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to_id: currentProfileId })});
                            const j = await r.json();
                            if (r.ok && j.ok) { showToast('تم إرسال طلب الصداقة.', { type: 'success' }); fetchAndDisplayProfile(); } else { showToast(j.error || 'فشل في إرسال الطلب.', { type: 'error' }); fetchAndDisplayProfile(); }
                        } catch (e) { showToast('خطأ في الشبكة', { type: 'error' }); fetchAndDisplayProfile(); }
                    });
                }
            }
            await fetchAndDisplayUserPosts(currentProfileId);
        } else {
            document.getElementById('userPostsFeed').innerHTML = `<div class="text-center text-red-500 p-8">لم يتم العثور على المستخدم @${currentProfileId}</div>`;
        }
    } catch (error) {
        console.error('Error fetching profile:', error);
        document.getElementById('userPostsFeed').innerHTML = '<div class="text-center text-red-500 p-8">حدث خطأ في جلب بيانات الملف الشخصي.</div>';
    }
}

/* ----------------- Presence & SSE ----------------- */

function setUserOnlineUI(userId, isOnline, lastSeenTs) {
    const selectors = document.querySelectorAll(`.avatar-wrapper[data-user-id="${userId}"]`);
    selectors.forEach(av => {
        const dot = av.querySelector('.status-indicator');
        if (!dot) return;
        if (isOnline) {
            dot.style.display = 'block';
        } else {
            dot.style.display = 'none';
        }
    });

    const profileAvatarWrap = document.getElementById('profileAvatarWrap');
    if (profileAvatarWrap && profileAvatarWrap.dataset.userId === userId) {
        const bigDot = document.getElementById('profileOnlineDot');
        const profileStatus = document.getElementById('profileStatus');
        
        if (isOnline) {
            if (bigDot) bigDot.style.display = 'block';
            if (profileStatus) profileStatus.textContent = 'متصل الآن';
            if (profileStatus) profileStatus.className = 'text-green-500 font-semibold text-sm block mt-1';
        } else {
            if (bigDot) bigDot.style.display = 'none';
            if (profileStatus) {
                profileStatus.textContent = formatLastSeen(lastSeenTs) || '';
                profileStatus.className = 'text-gray-400 text-sm block mt-1';
            }
        }
    }
}

function formatLastSeen(lastSeenTs) {
    if (!lastSeenTs) return '';
    const now = Date.now();
    const diff = Math.max(0, now - lastSeenTs);
    const seconds = Math.floor(diff / 1000);
    if (seconds < 60) return 'متصل منذ لحظات';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `آخر ظهور منذ ${minutes} دقيقة${minutes > 1 ? 'ً' : ''}`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `آخر ظهور منذ ${hours} ساعة${hours > 1 ? 'ً' : ''}`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `آخر ظهور منذ ${days} يوم${days > 1 ? 'ً' : ''}`;
    const d = new Date(lastSeenTs);
    return `آخر ظهور في ${d.toLocaleDateString('ar-EG')}`;
}

function startStatusPolling() {
    if (statusPollInterval) clearInterval(statusPollInterval);
    pollProfileStatus();
    statusPollInterval = setInterval(pollProfileStatus, 15000); 
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') pollProfileStatus();
    });
    window.addEventListener('beforeunload', () => {
        if (statusPollInterval) clearInterval(statusPollInterval);
    });
}

async function pollProfileStatus() {
    if (!currentProfileId) return;
    try {
        const r = await fetch(`/api/profile?userId=${encodeURIComponent(currentProfileId)}`, { cache: 'no-store' });
        if (!r.ok) return;
        const d = await r.json();
        if (d && d.ok) {
            setUserOnlineUI(currentProfileId, !!d.is_online, d.last_seen);
        }
    } catch (e) {
    }
}

/* ----------------- Init ----------------- */

document.addEventListener('DOMContentLoaded', () => {
    const postCommentBtn = document.getElementById('postCommentBtn');
    if (postCommentBtn) postCommentBtn.addEventListener('click', postComment);

    const newCommentInput = document.getElementById('newCommentInput');
    if (newCommentInput) {
        newCommentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); postComment(); }
        });
    }
    fetchAndDisplayProfile();
});

/* ----------------- small helpers ----------------- */
function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}
function escapeAttr(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/"/g, '&quot;');
}
</script>

</body>
</html>
