<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>الملف الشخصي</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --glass-bg: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.12);
      --accent: #7dd3fc;
      --muted: #cbd5e1;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg, #071426 0%, #0f1724 100%);
      color:var(--muted);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      direction: rtl;
    }

    .container{
      max-width:980px;
      margin:0 auto;
      height:100%;
      display: flex;
      flex-direction: column;
      padding:20px;
      box-sizing:border-box;
    }

    .back-link{
      text-decoration: none;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 20px;
    }

    main{
      flex:1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .profile-card{
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
    }
    .profile-picture-container{
      position:relative;
      width:100px;
      height:100px;
      margin:0 auto 20px;
    }
    .profile-picture{
      width:100%;
      height:100%;
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--accent);
    }
    .status-indicator{
      position:absolute;
      bottom:5px;
      right:5px;
      width:14px;
      height:14px;
      background-color:#4ade80; /* online color */
      border-radius:50%;
      border:2px solid var(--bg);
      display:none; /* hidden by default */
    }
    h1{
      font-size:24px;
      font-weight:600;
      color:#e6f0fb;
      margin:0 0 5px;
    }
    .username{
      font-size:16px;
      color:#94a3b8;
      margin:0 0 20px;
    }
    .info-item{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-bottom:15px;
      font-size:14px;
      color:#cbd5e1;
    }
    .info-item svg{
      color:var(--accent);
      width:18px;
      height:18px;
    }
    .verified-status{
      display:none; /* hidden by default */
      align-items:center;
      gap:6px;
      justify-content:center;
      font-size:12px;
      color: #7dd3fc;
      margin-top:-10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/chat_list" class="back-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
      </svg>
      عودة
    </a>
    <main>
      <div id="profile-card" class="profile-card">
        <div class="profile-picture-container">
          <img id="profile-picture" src="https://res.cloudinary.com/duixjs8az/image/upload/v1/profile_pics/default_profile.png" alt="Profile Picture" class="profile-picture">
          <span id="status-indicator" class="status-indicator"></span>
        </div>
        <h1 id="full-name">جارٍ التحميل...</h1>
        <p id="username" class="username"></p>
        <div id="info">
          <div class="info-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span id="email"></span>
          </div>
          <div class="verified-status" id="verified-status">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <span class="small">موثق</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    function getQuery(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    
    async function fetchUserProfile() {
      try {
        const userId = getQuery('user_id');
        const url = userId ? `/api/profile?user_id=${userId}` : '/api/profile';
        
        const res = await fetch(url, { credentials: 'same-origin' });
        if (res.status === 401) return window.location.href = '/login';
        const user = await res.json();
        
        if (user) {
          document.getElementById('profile-picture').src = escapeAttr(user.profile_picture_url);
          document.getElementById('full-name').textContent = user.full_name || user.username;
          document.getElementById('username').textContent = `@${user.username}`;
          document.getElementById('email').textContent = user.email;

          if (user.is_online) {
            document.getElementById('status-indicator').style.display = 'block';
          }
          if (user.is_verified) {
            document.getElementById('verified-status').style.display = 'flex';
          }
        }
      } catch (err) {
        console.error('Error fetching user profile:', err);
        document.getElementById('profile-card').innerHTML = '<p style="color:red">حدث خطأ أثناء جلب الملف الشخصي.</p>';
      }
    }

    function escapeAttr(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
      });
    }

    document.addEventListener('DOMContentLoaded', fetchUserProfile);
  </script>
</body>
</html>